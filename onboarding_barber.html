<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barber Onboarding</title>
    <link
      rel="icon"
      type="image/png"
      href="/STATIC/Images/icons/trimly logo.svg"
    />
  </head>
  <body>
    <script>
      // PREVENT ACCESS IF ONBOARDING IS ALREADY COMPLETE
      const isOnboardingComplete = localStorage.getItem("onboardingComplete");
      const hasOnboardingData = localStorage.getItem("onboardingData");

      // If onboarding is marked as complete AND there's valid data, redirect to dashboard
      if (isOnboardingComplete === "true" && hasOnboardingData) {
        window.location.href = "dashboard_barber.html";
      }
    </script>
    <div class="container">
      <h2>Set up your barber profile</h2>

      <!-- Progress -->
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- STEP 1: PROFILE -->
      <section class="step active">
        <h3>Profile Information</h3>

        <label>Barber / Business Name</label>
        <input type="text" id="name" required />

        <label>Phone Number</label>
        <input type="tel" id="phone" required />

        <label>Location</label>
        <input type="text" id="location" required />

        <label>Service Type</label>
        <select id="serviceType">
          <option value="shop">In-shop</option>
          <option value="home">Home service</option>
          <option value="both">Both</option>
        </select>

        <button onclick="nextStep()">Continue</button>
      </section>

      <!-- STEP 2: SERVICES -->
      <section class="step">
        <h3>Services & Pricing</h3>

        <div id="services"></div>

        <button class="secondary" onclick="addService()">+ Add Service</button>

        <div class="actions">
          <button class="secondary" onclick="prevStep()">Back</button>
          <button onclick="nextStep()">Continue</button>
        </div>
      </section>

      <!-- STEP 3: AVAILABILITY -->
      <section class="step">
        <h3>Select Available Days</h3>

        <div class="calendar-header" id="monthYear"></div>
        <div class="calendar-grid" id="calendar"></div>

        <label>General Availability Time</label>
        <div class="time-range">
          <input type="time" id="startTime" value="09:00" />
          <input type="time" id="endTime" value="18:00" />
        </div>

        <div class="actions">
          <button class="secondary" onclick="prevStep()">Back</button>
          <button onclick="finishOnboarding()">Finish Setup</button>
        </div>
      </section>
    </div>

    <style>
      * {
        box-sizing: border-box;
        font-family: system-ui, sans-serif;
      }

      body {
        background: #f7f7f7;
        padding: 20px;
      }

      .container {
        max-width: 420px;
        background: #fff;
        margin: auto;
        padding: 24px;
        border-radius: 8px;
      }

      h2 {
        margin-bottom: 16px;
      }

      .progress {
        height: 6px;
        background: #e5e5e5;
        border-radius: 3px;
        margin-bottom: 20px;
      }

      .progress-bar {
        height: 100%;
        width: 33%;
        background: #111;
        border-radius: 3px;
        transition: width 0.3s;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      label {
        display: block;
        margin-top: 12px;
      }

      input,
      select {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
      }

      button {
        width: 100%;
        padding: 10px;
        margin-top: 16px;
        background: #111;
        color: #fff;
        border: none;
        cursor: pointer;
      }

      button.secondary {
        background: #ddd;
        color: #111;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .day {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
        margin: 16px 0;
      }

      .calendar-day {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        cursor: pointer;
        border-radius: 4px;
      }

      .calendar-day.active {
        background: #111;
        color: #fff;
      }

      .calendar-header {
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .time-range {
        display: flex;
        gap: 10px;
      }

      @media (max-width: 480px) {
        .container {
          padding: 16px;
        }

        .actions button {
          flex: 1 1 100%;
        }

        .time-range input {
          flex: 1 1 100%;
        }

        .calendar-grid {
          gap: 4px;
        }

        input,
        select,
        button {
          font-size: 0.95rem;
        }
      }
    </style>
    <script>
      /************ DOM ELEMENTS ************/
      const steps = document.querySelectorAll(".step");
      const progressBar = document.getElementById("progressBar");

      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const locationInput = document.getElementById("location");
      const serviceType = document.getElementById("serviceType");

      const servicesContainer = document.getElementById("services");

      const startTime = document.getElementById("startTime");
      const endTime = document.getElementById("endTime");

      const calendar = document.getElementById("calendar");
      const monthYear = document.getElementById("monthYear");

      /************ STATE ************/
      let currentStep = 0;
      const selectedDates = new Set();

      /************ STEP HANDLING ************/
      function showStep(index) {
        steps.forEach((step) => step.classList.remove("active"));

        if (index >= 0 && index < steps.length) {
          steps[index].classList.add("active");
          progressBar.style.width = ((index + 1) / steps.length) * 100 + "%";
        }
      }

      function nextStep() {
        if (!validateStep(currentStep)) return;

        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
          saveProgress();
        }
      }

      function prevStep() {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      }

      /************ SERVICES ************/
      function addService() {
        const div = document.createElement("div");
        div.className = "service-item";

        div.innerHTML = `
    <input placeholder="Service name" />
    <input type="number" placeholder="Price" />
    <select>
      <option value="15">15 min</option>
      <option value="30">30 min</option>
      <option value="45">45 min</option>
      <option value="60">60 min</option>
    </select>
    <hr>
  `;

        servicesContainer.appendChild(div);
      }

      /************ VALIDATION ************/
      function validateStep(stepIndex) {
        if (stepIndex === 0) {
          if (!nameInput.value || !phoneInput.value || !locationInput.value) {
            alert("Please fill all profile fields");
            return false;
          }
        }

        if (stepIndex === 1) {
          const services = servicesContainer.querySelectorAll(".service-item");
          if (services.length === 0) {
            alert("Add at least one service");
            return false;
          }

          for (const div of services) {
            if (!div.children[0].value || !div.children[1].value) {
              alert("Please fill all service fields");
              return false;
            }
          }
        }

        if (stepIndex === 2) {
          if (selectedDates.size === 0) {
            alert("Select at least one available day");
            return false;
          }
        }

        return true;
      }

      /************ CALENDAR ************/
      function generateCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        monthYear.textContent = now.toLocaleString("default", {
          month: "long",
          year: "numeric",
        });

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        calendar.innerHTML = "";

        for (let day = 1; day <= daysInMonth; day++) {
          // FIX: Use YYYY-MM-DD format with leading zeros
          const dateKey = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const div = document.createElement("div");

          div.textContent = day;
          div.className = "calendar-day";

          if (selectedDates.has(dateKey)) {
            div.classList.add("active");
          }

          div.onclick = () => {
            if (selectedDates.has(dateKey)) {
              selectedDates.delete(dateKey);
              div.classList.remove("active");
            } else {
              selectedDates.add(dateKey);
              div.classList.add("active");
            }
            saveProgress();
          };

          calendar.appendChild(div);
        }
      }

      /************ STORAGE ************/
      function saveProgress() {
        const services = [
          ...servicesContainer.querySelectorAll(".service-item"),
        ].map((div) => ({
          name: div.children[0].value,
          price: div.children[1].value,
          duration: div.children[2].value,
        }));

        const data = {
          step: currentStep,
          profile: {
            name: nameInput.value,
            phone: phoneInput.value,
            location: locationInput.value,
            serviceType: serviceType.value,
          },
          services,
          availability: {
            days: [...selectedDates],
            startTime: startTime.value,
            endTime: endTime.value,
          },
        };

        localStorage.setItem("onboardingData", JSON.stringify(data));
      }

      function restoreProgress() {
        const saved = JSON.parse(localStorage.getItem("onboardingData"));
        if (!saved) return;

        nameInput.value = saved.profile.name || "";
        phoneInput.value = saved.profile.phone || "";
        locationInput.value = saved.profile.location || "";
        serviceType.value = saved.profile.serviceType || "";

        servicesContainer.innerHTML = "";
        saved.services.forEach((service) => {
          addService();
          const last = servicesContainer.lastElementChild;
          last.children[0].value = service.name;
          last.children[1].value = service.price;
          last.children[2].value = service.duration;
        });

        selectedDates.clear();
        saved.availability.days.forEach((d) => selectedDates.add(d));

        startTime.value = saved.availability.startTime || "";
        endTime.value = saved.availability.endTime || "";

        currentStep = saved.step || 0;
        showStep(currentStep);
        generateCalendar();
      }

      /************ FINISH ************/
      function finishOnboarding() {
        if (!validateStep(currentStep)) return;

        saveProgress();

        // Mark as complete
        localStorage.setItem("onboardingComplete", "true");

        // Add timestamp for when onboarding was completed
        const completionData = {
          completed: true,
          completedAt: new Date().toISOString(),
          version: "1.0",
        };
        localStorage.setItem(
          "onboardingCompletionData",
          JSON.stringify(completionData)
        );

        // Show success message before redirecting
        alert("Onboarding complete! Your barber profile is now ready.");

        // Redirect to dashboard
        window.location.href = "dashboard_barber.html";
      }

      /************ INIT ************/
      showStep(currentStep);
      generateCalendar();

      if (!localStorage.getItem("onboardingData")) {
        addService();
      }

      // Also need to convert existing dates if they're in old format
      function migrateExistingDates() {
        const saved = JSON.parse(localStorage.getItem("onboardingData"));
        if (!saved || !saved.availability || !saved.availability.days) return;

        const convertedDates = saved.availability.days.map((dateStr) => {
          // If date is in "2024-1-8" format, convert to "2024-01-08"
          const parts = dateStr.split("-");
          if (parts.length === 3) {
            const [year, month, day] = parts;
            return `${year}-${String(month).padStart(2, "0")}-${String(
              day
            ).padStart(2, "0")}`;
          }
          return dateStr;
        });

        saved.availability.days = convertedDates;
        localStorage.setItem("onboardingData", JSON.stringify(saved));

        // Update selectedDates
        selectedDates.clear();
        convertedDates.forEach((d) => selectedDates.add(d));
      }

      restoreProgress();
      migrateExistingDates();
    </script>
  </body>
</html>
