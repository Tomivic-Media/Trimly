<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      href="/STATIC/Images/icons/trimly logo.svg"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Sora:wght@100..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/STATIC/CSS/message.css" />
    <title>Messages</title>
  </head>
  <body>
    <div class="app-container">
      <div id="mobile-overlay"></div>

      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo-area">
            <span class="logo-text">Trimly</span>
            <!-- note: there are two visual toggles (sidebar icon & hamburger), JS handles both -->
            <i class="nav-icon sidebar-toggle-icon">
              <img src="/STATIC/Images/icons/trimly logo.svg" alt="" />
            </i>
          </div>
        </div>

        <nav class="nav-list">
          <a href="Home.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/Vector.svg" alt=""
            /></i>
            <span class="nav-label">Home</span>
          </a>
          <a href="favourite.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/mynaui_heart.svg" alt=""
            /></i>
            <span class="nav-label">Favourite</span>
          </a>
          <a href="message.html" class="nav-item active">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/message.svg" alt=""
            /></i>
            <span class="nav-label">Messages</span>
          </a>
          <a href="booking.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/bookings.svg" alt=""
            /></i>
            <span class="nav-label">Bookings</span>
          </a>
          <a href="setting.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/settings.svg" alt=""
            /></i>
            <span class="nav-label">Settings</span>
          </a>
        </nav>

        <div class="social-icons">
          <a href="#"
            ><i><img src="/STATIC/Images/fb.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/ig.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/x.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/messenger.svg" alt="" /></i
          ></a>
        </div>
      </aside>

      <!-- HAMBURGER BUTTON -->
      <button
        id="hamburger-btn"
        class="hamburger-btn"
        aria-label="Toggle sidebar"
      >
        <img src="/STATIC/Images/icons/trimly logo.svg" alt="menu" />
      </button>

      <!-- MAIN -->
      <main class="main-content">
        <header class="top-bar">
          <div class="search-container">
            <i style="font-size: 18px; color: rgba(0, 0, 0, 1)"
              ><img src="/STATIC/Images/search.svg" alt=""
            /></i>
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Search"
              aria-label="Search barbers"
            />
          </div>

          <div class="notificationwithprofile">
            <div class="notifications">
              <img
                src="/STATIC/Images/icons/notificatiion.svg"
                alt="Notifications"
              />
              <span
                class="notification-badge"
                data-count="0"
                id="notificationCount"
                >0</span
              >
            </div>

            <div class="profile">
              <div class="avatar avatar-image">T</div>
            </div>
          </div>
        </header>

        <div class="content-scroll-area">
          <p id="message-title">Messages</p>

          <div class="chat-search">
            <i><img src="/STATIC/Images/search.svg" alt="" /></i>
            <input id="sideSearch" placeholder="Search" class="search-input" />
          </div>

          <div class="messages-container">
            <div class="chat-list" id="chatList"></div>

            <div class="chat-area">
              <div class="chat-header" id="chatHeader">
                <span>Select a barber</span>
              </div>

              <div class="chat-body" id="chatBody"></div>

              <div id="reactionPicker" class="reaction-picker hidden">
                <span>üëç</span><span>‚ù§Ô∏è</span><span>üòÇ</span> <span>üòÆ</span
                ><span>üò¢</span><span>üôè</span>
              </div>

              <div class="chat-input">
                <input type="file" id="imageInput" accept="image/*" hidden />
                <button onclick="document.getElementById('imageInput').click()">
                  üì∑
                </button>

                <input id="messageInput" placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      /* ----------------------------
                 DATA: barbers (with verified)
                 ---------------------------- */
      const barbers = {
        1: {
          id: "1",
          name: "Ariyo barbing services",
          img: "/STATIC/Images/e3e57f5dd5ab20b760d3f389da7910e955587728.jpg",
          location: "Lagos",
          rating: 4.8,
          amount: 5000,
          desc: "Premium Lagos barbershop known for sharp fades, afro grooming, and clean modern cuts.",
          verified: true,
          priceTier: "mid",
          availability: [17, 24, 19, 29, 27, 5, 1, 22, 6, 10],

          reviews: [
            {
              name: "David Adepoju",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 5,
              date: "June 10, 2025",
              text: "Amazing service! My fade came out clean and sharp. Easily one of the best barbers in Lagos.",
            },
            {
              name: "Michael Femi",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 4,
              date: "June 5, 2025",
              text: "Good attention to detail. The shop was neat and he kept to time.",
            },
            {
              name: "Tunde Ilori",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 5,
              date: "May 28, 2025",
              text: "Best haircut I've had in months. Highly recommended.",
            },
          ],

          workingHours: [{ start: "07:00", end: "22:00" }],
        },

        2: {
          id: "2",
          name: "Fola barbing services",
          img: "/STATIC/Images/51dff4b5b6c4b24a89fc357e76ddb4bffa5f60cb.jpg",
          location: "Abuja",
          rating: 3.0,
          amount: 2500,
          desc: "Affordable neighborhood barbershop offering simple, clean haircuts at great value.",
          verified: false,
          priceTier: "low",
          availability: [16, 1, 3, 23, 7, 22, 19, 26, 25, 11],

          reviews: [
            {
              name: "Chibuzo Kingsley",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 3,
              date: "May 12, 2025",
              text: "Decent cut. Could improve timing but overall fair.",
            },
            {
              name: "Aisha Bello",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 4,
              date: "May 1, 2025",
              text: "Pleasant service, friendly barber. Good pricing.",
            },
            {
              name: "Yusuf Ahmed",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 2,
              date: "April 20, 2025",
              text: "Cut was okay but not exactly what I asked for.",
            },
          ],

          workingHours: [{ start: "07:00", end: "22:00" }],
        },

        3: {
          id: "3",
          name: "Adebisi barbing services",
          img: "/STATIC/Images/fd5eaeb566eaee245f79cac02879dbca4d66fb74.jpg",
          location: "Ibadan",
          rating: 4.2,
          amount: 4000,
          desc: "Professional Ibadan barber specializing in detailed fades, beard trims, and styling.",
          verified: true,
          priceTier: "mid",
          availability: [16, 13, 20, 24, 6, 8, 21, 25, 17, 3],
          reviews: [
            {
              name: "Kunle Owolabi",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 4,
              date: "June 2, 2025",
              text: "Very professional. My beard trim came out sharp.",
            },
            {
              name: "Samuel Peters",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 5,
              date: "May 27, 2025",
              text: "Excellent work. Definitely coming back.",
            },
            {
              name: "Ireti A.",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 4,
              date: "May 10, 2025",
              text: "Neat shop and good vibes. Loved the haircut.",
            },
          ],

          workingHours: [{ start: "07:00", end: "22:00" }],
        },

        4: {
          id: "4",
          name: "African barbing services",
          img: "/STATIC/Images/71954b1bf5bf641a949aa7d9565112e807cd9a25.jpg",
          location: "Ibadan",
          rating: 4.0,
          amount: 6500,
          desc: "Luxury grooming experience with premium tools, skilled barbers, and stylish ambience.",
          verified: false,
          priceTier: "high",
          availability: [10, 12, 14, 16, 4, 13, 22, 15, 9, 1],

          reviews: [
            {
              name: "Precious Daniel",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 4,
              date: "June 9, 2025",
              text: "Good service but a little pricey.",
            },
            {
              name: "Emeka U.",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 5,
              date: "June 1, 2025",
              text: "Great haircut, worth the money.",
            },
            {
              name: "Ola N.",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 3,
              date: "May 19, 2025",
              text: "Decent but expected a bit more for the price.",
            },
          ],
          workingHours: [{ start: "07:00", end: "22:00" }],
        },

        5: {
          id: "5",
          name: "Ayodele barbing services",
          img: "/STATIC/Images/89f0e267a3761a55a184609ef53967fc6beed6e6.jpg",
          location: "Abuja",
          rating: 3.5,
          amount: 3000,
          desc: "Quick and reliable barber service ideal for regular maintenance cuts and trims.",
          verified: false,
          priceTier: "low",
          availability: [8, 21, 16, 7, 28, 30, 1, 6, 24, 13],

          reviews: [
            {
              name: "Henry Okafor",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 4,
              date: "June 3, 2025",
              text: "Affordable and clean cut. Good value.",
            },
            {
              name: "Sade Ojo",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 3,
              date: "May 25, 2025",
              text: "Okay haircut, nothing extraordinary.",
            },
            {
              name: "Daniel O.",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 5,
              date: "May 14, 2025",
              text: "Excellent job. Will be returning.",
            },
          ],
          workingHours: [{ start: "07:00", end: "22:00" }],
        },

        6: {
          id: "6",
          name: "Rise barbing services",
          img: "/STATIC/Images/7e4c3695e25ee081e122f0dac2c4f7c7b0c3ccce.jpg",
          location: "Lagos",
          rating: 4.8,
          amount: 8000,
          desc: "High-end barbershop delivering premium fades, luxury grooming, and elite service.",
          verified: true,
          priceTier: "high",
          availability: [21, 13, 11, 28, 22, 10, 5, 2, 18, 7],

          reviews: [
            {
              name: "Favour Chinedu",
              avatar: "/STATIC/Images/icons/Frame review.png",
              rating: 5,
              date: "June 8, 2025",
              text: "Top-notch! The fade was perfect and the service was premium.",
            },
            {
              name: "Olawale Ade",
              avatar: "/STATIC/Images/icons/Frame review2.png",
              rating: 4,
              date: "June 4, 2025",
              text: "Loved the experience, great ambience.",
            },
            {
              name: "Kelvin U.",
              avatar: "/STATIC/Images/icons/Frame review3.png",
              rating: 5,
              date: "May 29, 2025",
              text: "Perfect haircut every time. Highly skilled barber.",
            },
          ],

          workingHours: [{ start: "07:00", end: "22:00" }],
        },
      };

      Object.values(barbers).forEach((b) => {
        b.online = Math.random() > 0.5;
        b.lastSeen = Date.now() - Math.floor(Math.random() * 3600000);
      });

      /* ----------------------------
                 SIDEBAR: toggle & overlay logic
                 ---------------------------- */
      const sidebar = document.getElementById("sidebar");
      const hamburgerBtn = document.getElementById("hamburger-btn");
      const overlay = document.getElementById("mobile-overlay");
      // multiple toggle icons might exist
      function getSidebarToggleElements() {
        const arr = Array.from(
          document.querySelectorAll(".sidebar-toggle-icon")
        );
        // also include hamburger icon if it should toggle collapsed state on desktop
        return arr;
      }

      function toggleSidebar() {
        const isMobile = window.innerWidth <= 1024;
        if (isMobile) {
          sidebar.classList.toggle("mobile-open");
          if (sidebar.classList.contains("mobile-open")) {
            overlay.style.display = "block";
            setTimeout(() => (overlay.style.opacity = "1"), 10);
          } else {
            overlay.style.opacity = "0";
            setTimeout(() => (overlay.style.display = "none"), 300);
          }
        } else {
          sidebar.classList.toggle("collapsed");
        }
      }

      // Attach toggle listeners
      getSidebarToggleElements().forEach((el) =>
        el.addEventListener("click", toggleSidebar)
      );
      hamburgerBtn.addEventListener("click", () => {
        hamburgerBtn.classList.toggle("active");
        toggleSidebar();
      });

      overlay.addEventListener("click", () => {
        sidebar.classList.remove("mobile-open");
        overlay.style.opacity = "0";
        setTimeout(() => (overlay.style.display = "none"), 300);
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
          sidebar.classList.remove("mobile-open");
          overlay.style.display = "none";
          overlay.style.opacity = "0";
        }
      });

      let activeBarberId = null;

      /* ------------------ INIT ------------------ */
      const params = new URLSearchParams(window.location.search);
      activeBarberId = params.get("barberId");

      renderChatList();

      if (activeBarberId) {
        openChat(activeBarberId);
      }

      /* ------------------ FUNCTIONS ------------------ */
      function renderChatList() {
        const list = document.getElementById("chatList");
        list.innerHTML = "";

        Object.values(barbers).forEach((barber) => {
          const div = document.createElement("div");
          div.className = "chat-item";
          div.dataset.id = barber.id;

          div.innerHTML = `
        <img src="${barber.img}" />
        <div>
          <div class="chat-name">${barber.name}</div>
          <small>Tap to chat</small>
        </div>
      `;

          div.onclick = () => openChat(barber.id);
          list.appendChild(div);
        });
      }

      function openChat(barberId) {
        activeBarberId = barberId;

        document.querySelectorAll(".chat-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.id === barberId);
        });

        const barber = barbers[barberId];
        const header = document.getElementById("chatHeader");

        header.innerHTML = `
  <img src="${barber.img}" />
  <div>
    <strong>${barber.name}</strong>
    <div class="status">
      ${barber.online ? "Online" : "Last seen " + formatTime(barber.lastSeen)}
    </div>
  </div>
`;

        renderMessages();
      }

      function getMessages(barberId) {
        return (
          JSON.parse(localStorage.getItem("chat_" + barberId)) || [
            {
              sender: "barber",
              text: "Hey bro üëã",
              type: "text", // "text" | "image"
              image: "", // optional (base64 / URL)
              time: Date.now(),
              status: "sent", // sent | delivered | seen
            },
            {
              sender: "user", // "user" | "barber"
              type: "text", // "text" | "image"
              text: "Hello üëã", // optional
              image: "", // optional (base64 / URL)
              time: Date.now(),
              status: "sent", // sent | delivered | seen
            },
          ]
        );
      }

      function renderMessages() {
        const body = document.getElementById("chatBody");
        body.innerHTML = "";

        const messages = getMessages(activeBarberId);

        messages.forEach((msg, index) => {
          const div = document.createElement("div");
          div.className = `message ${msg.sender}`;

          if (msg.type === "image") {
            div.innerHTML = `
        <img src="${msg.image}" class="chat-image" />
        ${renderMeta(msg)}
      `;
          } else {
            div.innerHTML = `
        <span>${msg.text}</span>
        ${renderMeta(msg)}
      `;
          }

          if (msg.reaction) {
            div.innerHTML += `<div class="reaction">${msg.reaction}</div>`;
          }

          attachReactionHandlers(div, index);
          body.appendChild(div);
        });

        body.scrollTop = body.scrollHeight;
      }

      function formatTime(timestamp) {
        if (!timestamp) return "";
        const date = new Date(Number(timestamp));
        if (isNaN(date.getTime())) return "";
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function renderMeta(msg) {
        const time = formatTime(msg.time);

        let ticks = "";
        if (msg.sender === "user") {
          if (msg.status === "sent") ticks = "‚úì";
          if (msg.status === "delivered") ticks = "‚úì‚úì";
          if (msg.status === "seen") ticks = `<span class="seen">‚úì‚úì</span>`;
        }

        return `
    <div class="message-meta">
      <span class="time">${time}</span>
      <span class="ticks">${ticks}</span>
    </div>
  `;
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        if (!input.value.trim() || !activeBarberId) return;

        const messages = getMessages(activeBarberId);

        messages.push({
          sender: "user",
          type: "text",
          text: input.value,
          image: "",
          time: Date.now(), // ‚úÖ REQUIRED
          status: "sent", // ‚úÖ REQUIRED
          reaction: "", // for reactions
        });

        localStorage.setItem(
          "chat_" + activeBarberId,
          JSON.stringify(messages)
        );

        input.value = "";
        renderMessages();

        simulateBarberReply(); // optional
      }

      // Function to filter chat list based on search input
      function filterChatList(searchTerm) {
        const list = document.getElementById("chatList");
        const items = list.querySelectorAll(".chat-item");

        items.forEach((item) => {
          const barberName = item
            .querySelector(".chat-name")
            .textContent.toLowerCase();
          if (barberName.includes(searchTerm.toLowerCase())) {
            item.style.display = "flex"; // show
          } else {
            item.style.display = "none"; // hide
          }
        });
      }

      // Sidebar search input
      const sideSearchInput = document.getElementById("sideSearch");
      sideSearchInput.addEventListener("input", (e) => {
        filterChatList(e.target.value);
      });

      // Optional: Top search input (if you want to filter chat list too)
      const topSearchInput = document.getElementById("searchInput");
      topSearchInput.addEventListener("input", (e) => {
        filterChatList(e.target.value);
      });

      const reactionPicker = document.getElementById("reactionPicker");
      let activeMessageIndex = null;
      let longPressTimer = null;

      function attachReactionHandlers(messageEl, msgIndex) {
        // Desktop right click
        messageEl.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          showReactionPicker(e.pageX, e.pageY, msgIndex);
        });

        // Mobile long press
        messageEl.addEventListener("touchstart", (e) => {
          longPressTimer = setTimeout(() => {
            const touch = e.touches[0];
            showReactionPicker(touch.pageX, touch.pageY, msgIndex);
          }, 500);
        });

        messageEl.addEventListener("touchend", () => {
          clearTimeout(longPressTimer);
        });

        messageEl.addEventListener("touchmove", () => {
          clearTimeout(longPressTimer);
        });
      }

      reactionPicker.addEventListener("click", (e) => {
        const emoji = e.target.textContent;
        if (!emoji) return;

        const messages = getMessages(activeBarberId);
        const msg = messages[activeMessageIndex];

        // Toggle reaction
        msg.reaction = msg.reaction === emoji ? "" : emoji;

        localStorage.setItem(
          "chat_" + activeBarberId,
          JSON.stringify(messages)
        );

        reactionPicker.style.display = "none"; // ‚úÖ HIDE
        activeMessageIndex = null;

        renderMessages();
      });

      document.addEventListener("click", (e) => {
        const picker = document.getElementById("reactionPicker");
        if (!picker.contains(e.target)) {
          picker.style.display = "none";
          activeMessageIndex = null;
        }
      });

      function showReactionPicker(x, y, index) {
        const picker = document.getElementById("reactionPicker");
        activeMessageIndex = index;

        picker.style.left = x + "px";
        picker.style.top = y + "px";
        picker.style.display = "flex"; // ‚úÖ SHOW
      }

      function simulateBarberReply() {
        if (!activeBarberId) return;

        setTimeout(() => {
          const messages = getMessages(activeBarberId);

          messages.push({
            sender: "barber",
            type: "text",
            text: "Sure bro üëç I‚Äôll be ready for you.",
            time: Date.now(),
            status: "delivered",
            reaction: "",
          });

          localStorage.setItem(
            "chat_" + activeBarberId,
            JSON.stringify(messages)
          );

          renderMessages();

          // üîî NOTIFICATION TRIGGER
          notifyNewMessage(barbers[activeBarberId].name, activeBarberId);
        }, 2000);
      }

      document.getElementById("imageInput").onchange = function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          const messages = getMessages(activeBarberId);
          messages.push({
            sender: "user",
            type: "image",
            image: reader.result,
            time: Date.now(),
            status: "sent",
            reaction: "",
          });

          localStorage.setItem(
            "chat_" + activeBarberId,
            JSON.stringify(messages)
          );

          renderMessages();
        };
        reader.readAsDataURL(file);
      };

      document
        .getElementById("messageInput")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendMessage();
        });

      function updateAllAvatars() {
        const avatar = localStorage.getItem("trimly_avatar");
        if (!avatar) return;

        document.querySelectorAll(".avatar").forEach((el) => {
          el.style.backgroundImage = `url(${avatar})`;
          el.style.backgroundSize = "cover";
          el.style.backgroundPosition = "center";
          el.textContent = ""; // remove initials
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAllAvatars();
      });
    </script>
    <script src="./TrimlyNotifications.js"></script>

    <div id="toast" class="toast"></div>
  </body>
</html>
