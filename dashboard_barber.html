<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trimly | Barber Dashboard</title>
    <link
      rel="icon"
      type="image/png"
      href="/STATIC/Images/icons/trimly logo.svg"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
        --color-bg-sidebar: #f9fafb;
        --color-bg-main: #ffffff;
        --color-text-primary: #000000;
        --color-text-secondary: #6b7280;
        --color-accent: rgba(218, 228, 243, 1);
        --color-border: #e5e7eb;
        --color-hover: rgba(240, 240, 240, 1);
        --sidebar-width-expanded: 250px;
        --sidebar-width-collapsed: 80px;
        --header-height: 80px;
        --transition-speed: 0.3s;

        /* Dashboard Colors */
        --primary: #111827;
        --secondary: #3b82f6;
        --secondary-light: #60a5fa;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
        --white: #ffffff;
        --off-white: #f9fafb;
        --light-gray: #f3f4f6;
        --gray: #9ca3af;
        --dark-gray: #6b7280;
        --black: #111827;
        --radius: 10px;
        --radius-lg: 14px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, sans-serif;
        background: var(--off-white);
        color: var(--black);
        min-height: 100vh;
        line-height: 1.5;
        overflow-x: hidden;
      }

      /* App Container */
      .app-container {
        display: flex;
        height: 100vh;
        width: 100%;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width-expanded);
        background-color: var(--color-bg-sidebar);
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        transition: all var(--transition-speed);
        flex-shrink: 0;
        overflow-x: hidden;
        height: 100vh;
        position: relative;
        z-index: 1000;
      }

      .sidebar.collapsed {
        width: var(--sidebar-width-collapsed);
      }

      .sidebar.collapsed .logo-text,
      .sidebar.collapsed .nav-label,
      .sidebar.collapsed .social-icons {
        opacity: 0;
        pointer-events: none;
      }

      /* Simple solution: Show only logo when collapsed */
      .sidebar.collapsed .logo-area {
        justify-content: center;
        padding: 20px 0;
      }

      .sidebar.collapsed .logo-text {
        display: none;
      }

      .sidebar.collapsed .sidebar-toggle-icon img {
        opacity: 1 !important;
        visibility: visible !important;
      }

      .sidebar-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: 700;
      }

      .nav-list {
        flex: 1;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-radius: 8px;
        color: var(--color-text-secondary);
        transition: all 0.2s;
        gap: 12px;
        text-decoration: none;
      }

      .nav-item:hover {
        background-color: var(--color-hover);
        color: var(--color-text-primary);
      }

      .nav-item.active {
        background-color: var(--color-accent);
        color: var(--color-text-primary);
        font-weight: 500;
      }

      .nav-icon img {
        width: 18px;
        height: 18px;
      }

      .social-icons {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }

      /* Mobile Overlay */
      #mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      /* Hamburger Button */
      .hamburger-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1002;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
      }

      .hamburger-btn img {
        width: 24px;
        height: 24px;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background-color: var(--white);
        width: calc(100% - var(--sidebar-width-expanded));
        height: 100vh;
        transition: margin-left var(--transition-speed);
      }

      .sidebar.collapsed ~ .main-content {
        margin-left: var(--sidebar-width-collapsed);
        width: calc(100% - var(--sidebar-width-collapsed));
      }

      /* Header */
      .header {
        height: 70px;
        background: var(--white);
        border-bottom: 1px solid var(--light-gray);
        padding: 0 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 900;
      }

      .header-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--black);
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--gray);
      }

      .breadcrumb .active {
        color: var(--black);
        font-weight: 500;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .header-actions {
        display: flex;
        gap: 12px;
      }

      .header-action-btn {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--light-gray);
        background: var(--white);
        color: var(--dark-gray);
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--error);
        color: var(--white);
        font-size: 0.7rem;
        font-weight: 600;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .date-display,
      .location-display {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--light-gray);
        border-radius: var(--radius);
        font-size: 0.9rem;
        color: var(--dark-gray);
        font-weight: 500;
      }

      /* Dashboard Container */
      .dashboard-container {
        padding: 32px;
        overflow-y: auto;
        height: calc(100vh - 70px);
      }

      /* Welcome Section */
      .welcome-section {
        margin-bottom: 32px;
      }

      .welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--radius-lg);
        padding: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-lg);
      }

      .welcome-content h2 {
        color: white;
        margin-bottom: 12px;
        font-size: 1.8rem;
      }

      .welcome-content p {
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 20px;
        font-size: 1.1rem;
      }

      .welcome-stats {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
      }

      .welcome-stat {
        display: flex;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.9);
      }

      .welcome-stat strong {
        color: white;
        font-weight: 600;
      }

      .welcome-actions {
        display: flex;
        gap: 12px;
      }

      /* Stats Cards */
      .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: var(--shadow);
        transition: all 0.25s ease;
        border: 1px solid var(--light-gray);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .stat-icon {
        width: 64px;
        height: 64px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: var(--white);
      }

      .stat-info h3 {
        font-size: 2.2rem;
        margin-bottom: 4px;
        color: var(--black);
      }

      .stat-info p {
        color: var(--dark-gray);
        margin-bottom: 8px;
      }

      .stat-trend {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
        color: var(--gray);
      }

      .stat-trend.positive {
        color: var(--success);
      }

      .rating-stars {
        display: flex;
        gap: 2px;
        color: var(--warning);
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 32px;
      }

      /* Cards */
      .card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 24px;
        border: 1px solid var(--light-gray);
      }

      .card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .card-title h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
      }

      .card-subtitle {
        font-size: 0.9rem;
        color: var(--gray);
        margin-left: 8px;
      }

      .card-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .card-body {
        padding: 24px;
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border-radius: var(--radius);
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.95rem;
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--secondary) 0%,
          var(--secondary-light) 100%
        );
        color: var(--white);
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .btn-secondary {
        background: var(--white);
        color: var(--dark-gray);
        border: 1px solid var(--light-gray);
      }

      .btn-secondary:hover {
        background: var(--light-gray);
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--light-gray);
        background: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      /* Today's Bookings */
      .bookings-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .booking-item {
        padding: 20px;
        border-radius: var(--radius);
        border: 1px solid var(--light-gray);
        margin-bottom: 16px;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .booking-item:hover {
        transform: translateX(5px);
        border-color: var(--secondary-light);
        box-shadow: var(--shadow);
      }

      .booking-item.active {
        border-left: 4px solid var(--secondary);
        background: var(--off-white);
      }

      .booking-info h4 {
        font-size: 1.1rem;
        margin-bottom: 6px;
      }

      .booking-meta {
        display: flex;
        gap: 16px;
        font-size: 0.9rem;
        color: var(--dark-gray);
      }

      .booking-status {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .status-confirmed {
        background: #d1fae5;
        color: var(--success);
      }

      .status-pending {
        background: #fef3c7;
        color: var(--warning);
      }

      /* My Services */
      .my-services .services-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
      }

      .service-card {
        background: var(--off-white);
        border-radius: var(--radius);
        padding: 16px;
        border: 1px solid var(--light-gray);
        transition: all 0.25s ease;
      }

      .service-card:hover {
        border-color: var(--secondary-light);
        box-shadow: var(--shadow);
      }

      .service-card h5 {
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .service-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 4px;
      }

      .service-duration {
        font-size: 0.9rem;
        color: var(--gray);
      }

      /* Calendar */
      .calendar-grid {
        padding: 16px 20px;
      }

      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: 600;
        color: var(--dark-gray);
        font-size: 0.85rem;
        margin-bottom: 12px;
      }

      .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
        border: 1px solid var(--light-gray);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.25s ease;
        position: relative;
      }

      .calendar-day:hover {
        background: var(--light-gray);
      }

      .calendar-day.today {
        background: black;
        color: var(--white);
        border-color: var(--secondary);
      }

      .calendar-day.has-booking::after {
        content: "";
        position: absolute;
        bottom: 6px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        background: black;
        border-radius: 50%;
      }

      .calendar-day.other-month {
        color: var(--gray);
        background: var(--off-white);
      }

      .calendar-events {
        padding: 20px;
        border-top: 1px solid var(--light-gray);
      }

      .event-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .event-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid var(--light-gray);
      }

      /* Quick Actions */
      .action-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 20px;
      }

      .action-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 20px 12px;
        border-radius: var(--radius);
        border: 1px solid var(--light-gray);
        background: var(--white);
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .action-card:hover {
        transform: translateY(-5px);
        border-color: var(--secondary-light);
        box-shadow: var(--shadow);
      }

      .action-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      /* Recent Clients */
      .clients-list {
        padding: 8px 0;
      }

      .client-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: var(--radius);
        transition: all 0.25s ease;
      }

      .client-item:hover {
        background: var(--off-white);
      }

      .client-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--light-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dark-gray);
      }

      .client-info {
        flex: 1;
      }

      .client-info h5 {
        font-size: 0.95rem;
        margin-bottom: 2px;
      }

      /* Loading States */
      .loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--light-gray);
        border-top-color: var(--secondary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .spinner.small {
        width: 20px;
        height: 20px;
        border-width: 2px;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        color: var(--light-gray);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 32px;
        right: 32px;
        padding: 16px 24px;
        border-radius: var(--radius);
        color: var(--white);
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        z-index: 1200;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        max-width: 350px;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.success {
        background: var(--success);
      }

      .toast.error {
        background: var(--error);
      }

      .toast.info {
        background: var(--info);
      }

      .toast.warning {
        background: var(--warning);
      }

      /* Modals */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
        padding: 20px;
      }

      .modal-content {
        background: var(--white);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--light-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        padding: 24px;
      }

      .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--light-gray);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--light-gray);
        border-radius: 8px;
        font-size: 1rem;
      }

      .form-group textarea {
        resize: vertical;
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 1024px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          transform: translateX(-100%);
          z-index: 1000;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0 !important;
          width: 100% !important;
        }

        .hamburger-btn {
          display: flex;
          transition: opacity 0.3s ease;
        }

        .sidebar.mobile-open ~ .hamburger-btn {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .stats-summary {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .dashboard-container {
          padding: 16px;
        }

        .header {
          padding: 0 16px;
          flex-direction: column;
          gap: 16px;
          height: auto;
          padding: 16px;
        }

        .header-right {
          flex-wrap: wrap;
          justify-content: center;
          gap: 12px;
        }

        .welcome-card {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .welcome-actions {
          flex-direction: column;
          width: 100%;
        }

        .action-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 10px;
        }

        .modal-footer {
          flex-direction: column;
        }

        .modal-footer .btn {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .card-header {
          flex-direction: column;
          gap: 16px;
          align-items: flex-start;
        }

        .card-actions {
          width: 100%;
          justify-content: space-between;
        }
      }

      .calendar-day.available-day {
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .calendar-day {
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
      }

      .calendar-day:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .calendar-day.available-day:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .calendar-day.other-month {
        cursor: default;
        opacity: 0.4;
      }

      .calendar-day.other-month:hover {
        transform: none;
        box-shadow: none;
      }

      .calendar-day.today.available-day {
        border: 2px solid #ffffff;
        box-shadow: 0 0 0 2px #000000;
      }
    </style>
  </head>
  <body>
    <script>
      // Check if onboarding is complete - FIXED WITH PROPER CHECK
      const onboardingComplete = localStorage.getItem("onboardingComplete");
      const hasOnboardingData = localStorage.getItem("onboardingData");

      // Only redirect if onboarding is not complete AND no data exists
      if (!onboardingComplete || onboardingComplete !== "true") {
        if (!hasOnboardingData) {
          window.location.href = "onboarding_barber.html";
        } else {
          // If there's data but flag isn't set, set it now
          localStorage.setItem("onboardingComplete", "true");
        }
      }
    </script>

    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo-area">
            <span class="logo-text">Trimly</span>
            <i class="nav-icon sidebar-toggle-icon">
              <img src="/STATIC/Images/icons/trimly logo.svg" alt="" />
            </i>
          </div>
        </div>

        <nav class="nav-list">
          <a href="dashboard_barber.html" class="nav-item active">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/Vector.svg" alt=""
            /></i>
            <span class="nav-label">Dashboard</span>
          </a>
          <a href="messages_barber.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/message.svg" alt=""
            /></i>
            <span class="nav-label">Messages</span>
          </a>
          <a href="booking_barber.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/bookings.svg" alt=""
            /></i>
            <span class="nav-label">Bookings</span>
          </a>
          <a href="Settings_barber.html" class="nav-item">
            <i class="nav-icon"
              ><img src="/STATIC/Images/icons/settings.svg" alt=""
            /></i>
            <span class="nav-label">Settings</span>
          </a>
        </nav>

        <div class="social-icons">
          <a href="#"
            ><i><img src="/STATIC/Images/fb.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/ig.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/x.svg" alt="" /></i
          ></a>
          <a href="#"
            ><i><img src="/STATIC/Images/icons/messenger.svg" alt="" /></i
          ></a>
        </div>
      </aside>

      <!-- Hamburger Button -->
      <button
        id="hamburger-btn"
        class="hamburger-btn"
        aria-label="Toggle sidebar"
      >
        <img src="/STATIC/Images/icons/trimly logo.svg" alt="menu" />
      </button>

      <!-- Mobile Overlay -->
      <div id="mobile-overlay"></div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <h1 class="page-title">Dashboard</h1>
            <div class="breadcrumb">
              <span>Home</span>
              <i class="fas fa-chevron-right"></i>
              <span class="active">Dashboard</span>
            </div>
          </div>

          <div class="header-right">
            <div class="header-actions">
              <button class="header-action-btn" id="notificationsBtn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
              </button>
              <button
                class="header-action-btn"
                onclick="location.href='messages_barber.html'"
                id="messagesBtn"
              >
                <i class="fas fa-envelope"></i>
                <span class="notification-badge">5</span>
              </button>
            </div>

            <div class="date-display">
              <i class="fas fa-calendar-day"></i>
              <span id="todayDate"></span>
            </div>

            <div class="location-display">
              <i class="fas fa-map-marker-alt"></i>
              <span id="barberLocation">Location</span>
            </div>
          </div>
        </header>

        <!-- Dashboard Content -->
        <main class="dashboard-container">
          <!-- Welcome Section -->
          <section class="welcome-section">
            <div class="welcome-card">
              <div class="welcome-content">
                <h2>Welcome back, <span id="welcomeName">Barber</span>!</h2>
                <p>
                  Your dashboard is ready with
                  <span id="serviceCount">0</span> services and
                  <span id="availableDays">0</span> available days this month.
                </p>
                <div class="welcome-stats">
                  <div class="welcome-stat">
                    <i class="fas fa-clock"></i>
                    <span
                      >Business Hours:
                      <strong id="businessHours"
                        >9:00 AM - 6:00 PM</strong
                      ></span
                    >
                  </div>
                  <div class="welcome-stat">
                    <i class="fas fa-cut"></i>
                    <span
                      >Service Type:
                      <strong id="businessType">In-shop</strong></span
                    >
                  </div>
                </div>
              </div>
              <div class="welcome-actions">
                <button class="btn btn-secondary" onclick="editProfile()">
                  <i class="fas fa-edit"></i> Edit Profile
                </button>
                <button class="btn btn-primary" onclick="viewAvailability()">
                  <i class="fas fa-calendar-check"></i> View Calendar
                </button>
              </div>
            </div>
          </section>

          <!-- Stats Cards -->
          <section class="stats-summary">
            <div class="stat-card">
              <div
                class="stat-icon"
                style="
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                "
              >
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-info">
                <h3 id="todayCount">0</h3>
                <p>Today's Appointments</p>
                <div class="stat-trend positive">
                  <i class="fas fa-arrow-up"></i>
                  <span id="todayTrend">Loading...</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="
                  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                "
              >
                <i class="fas fa-clock"></i>
              </div>
              <div class="stat-info">
                <h3 id="upcomingCount">0</h3>
                <p>Upcoming This Week</p>
                <div class="stat-trend" id="upcomingTrend">
                  <i class="fas fa-minus"></i>
                  <span>Loading...</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="
                  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                "
              >
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="stat-info">
                <h3><span id="revenueCount">0</span></h3>
                <p>Projected Revenue</p>
                <div class="stat-trend positive">
                  <i class="fas fa-arrow-up"></i>
                  <span id="revenueTrend">Loading...</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="
                  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                "
              >
                <i class="fas fa-star"></i>
              </div>
              <div class="stat-info">
                <h3 id="averageRating">4.8</h3>
                <p>Average Rating</p>
                <div class="rating-stars">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star-half-alt"></i>
                </div>
              </div>
            </div>
          </section>

          <!-- Main Dashboard Grid -->
          <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="dashboard-left">
              <!-- Today's Bookings -->
              <section class="card today-bookings">
                <div class="card-header">
                  <div class="card-title">
                    <h3><i class="fas fa-list"></i> Today's Bookings</h3>
                    <span class="card-subtitle" id="todayDateShort"></span>
                  </div>
                  <div class="card-actions">
                    <button
                      class="btn-icon"
                      title="Refresh"
                      onclick="loadTodayBookings()"
                    >
                      <i class="fas fa-sync-alt"></i>
                    </button>
                    <button
                      class="btn-icon"
                      title="Filter"
                      onclick="filterBookings()"
                    >
                      <i class="fas fa-filter"></i>
                    </button>
                    <button
                      class="btn btn-primary btn-sm"
                      onclick="addBooking()"
                    >
                      <i class="fas fa-plus"></i> Add Booking
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="todayBookings" class="bookings-list">
                    <div class="loading">
                      <div class="spinner"></div>
                      <p>Loading today's appointments...</p>
                    </div>
                  </div>
                </div>
              </section>

              <!-- My Services -->
              <section class="card my-services">
                <div class="card-header">
                  <h3><i class="fas fa-cut"></i> My Services</h3>
                  <button
                    class="btn btn-secondary btn-sm"
                    onclick="manageServices()"
                  >
                    <i class="fas fa-edit"></i> Manage
                  </button>
                </div>
                <div class="card-body">
                  <div id="servicesList" class="services-list">
                    <div class="loading">
                      <div class="spinner small"></div>
                      <p>Loading services...</p>
                    </div>
                  </div>
                </div>
              </section>
            </div>

            <!-- Right Column -->
            <div class="dashboard-right">
              <!-- Calendar -->
              <section class="card mini-calendar">
                <div class="card-header">
                  <div class="card-title">
                    <h3><i class="fas fa-calendar-alt"></i> Calendar</h3>
                    <span class="card-subtitle"
                      >Click days to toggle availability</span
                    >
                  </div>
                  <div class="card-actions">
                    <div class="month-nav">
                      <button id="prevMonth" class="btn-icon">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <span id="currentMonth"></span>
                      <button id="nextMonth" class="btn-icon">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    <button
                      class="btn-icon"
                      onclick="clearAllAvailability()"
                      title="Clear all availability"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="calendar-grid">
                  <div class="calendar-weekdays">
                    <div>S</div>
                    <div>M</div>
                    <div>T</div>
                    <div>W</div>
                    <div>T</div>
                    <div>F</div>
                    <div>S</div>
                  </div>
                  <div id="miniCalendar" class="calendar-days"></div>
                </div>
                <div class="calendar-events">
                  <h4>Availability This Month</h4>
                  <div class="event-list">
                    <div class="event-item" id="availabilitySummary">
                      <i class="fas fa-check-circle" style="color: #000"></i>
                      <div class="event-details">
                        <h5>Available Days</h5>
                        <p id="availableDaysCount">Loading...</p>
                      </div>
                    </div>
                    <div class="event-item">
                      <i class="fas fa-clock" style="color: #3b82f6"></i>
                      <div class="event-details">
                        <h5>Business Hours</h5>
                        <p id="businessHoursDetail">9:00 AM - 6:00 PM</p>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <!-- Quick Actions -->
              <!-- Quick Actions -->
              <section class="card quick-actions">
                <div class="card-header">
                  <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                  <button
                    class="btn btn-secondary btn-sm"
                    onclick="syncWithOnboarding()"
                  >
                    <i class="fas fa-sync"></i> Sync Calendar
                  </button>
                </div>
                <div class="action-grid">
                  <button class="action-card" onclick="addBooking()">
                    <div class="action-icon" style="background: #e3f2fd">
                      <i
                        class="fas fa-calendar-plus"
                        style="color: #1976d2"
                      ></i>
                    </div>
                    <span>Add Booking</span>
                  </button>
                  <button class="action-card" onclick="blockTimeModal()">
                    <div class="action-icon" style="background: #f3e5f5">
                      <i class="fas fa-ban" style="color: #7b1fa2"></i>
                    </div>
                    <span>Block Time</span>
                  </button>
                  <button class="action-card" onclick="viewAllBookings()">
                    <div class="action-icon" style="background: #e8f5e9">
                      <i
                        class="fas fa-calendar-week"
                        style="color: #388e3c"
                      ></i>
                    </div>
                    <span>View All Bookings</span>
                  </button>
                  <button
                    class="action-card"
                    onclick="manageAvailabilityModal()"
                  >
                    <div class="action-icon" style="background: #fff3e0">
                      <i class="fas fa-user-clock" style="color: #f57c00"></i>
                    </div>
                    <span>Availability</span>
                  </button>
                </div>
              </section>

              <!-- Recent Clients -->
              <section class="card recent-clients">
                <div class="card-header">
                  <h3><i class="fas fa-users"></i> Recent Clients</h3>
                </div>
                <div class="clients-list" id="recentClients">
                  <div class="client-item">
                    <div class="client-avatar">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="client-info">
                      <h5>John Doe</h5>
                      <p>Last visit: Today</p>
                    </div>
                    <div class="client-action">
                      <button class="btn-icon small">
                        <i class="fas fa-phone"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="bookingModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Booking Details</h3>
          <button class="btn-icon close-modal" onclick="closeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="bookingDetails"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">
            Close
          </button>
          <button
            class="btn btn-danger"
            id="cancelBookingBtn"
            onclick="cancelBooking()"
          >
            <i class="fas fa-times-circle"></i> Cancel Booking
          </button>
          <button
            class="btn btn-primary"
            id="confirmBookingBtn"
            onclick="confirmBooking()"
          >
            <i class="fas fa-check-circle"></i> Confirm Arrival
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="addBookingModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Booking</h3>
          <button class="btn-icon close-modal" onclick="closeAddModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="addBookingForm">
            <div class="form-group">
              <label for="customerName"
                ><i class="fas fa-user"></i> Customer Name</label
              >
              <input type="text" id="customerName" required />
            </div>
            <div class="form-group">
              <label for="customerPhone"
                ><i class="fas fa-phone"></i> Phone Number</label
              >
              <input type="tel" id="customerPhone" required />
            </div>
            <div class="form-group">
              <label for="serviceType"
                ><i class="fas fa-cut"></i> Service Type</label
              >
              <select id="serviceType" required>
                <option value="">Select a service</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bookingDate"
                ><i class="fas fa-calendar"></i> Date</label
              >
              <input type="date" id="bookingDate" required />
            </div>
            <div class="form-group">
              <label for="bookingTime"><i class="fas fa-clock"></i> Time</label>
              <select id="bookingTime" required>
                <option value="">Select a time</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bookingNotes"
                ><i class="fas fa-sticky-note"></i> Notes</label
              >
              <textarea id="bookingNotes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeAddModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveNewBooking()">
            <i class="fas fa-calendar-plus"></i> Add Booking
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="editProfileModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Profile</h3>
          <button class="btn-icon close-modal" onclick="closeEditModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <div class="form-group">
              <label for="editName"
                ><i class="fas fa-user"></i> Barber / Business Name</label
              >
              <input type="text" id="editName" required />
            </div>
            <div class="form-group">
              <label for="editPhone"
                ><i class="fas fa-phone"></i> Phone Number</label
              >
              <input type="tel" id="editPhone" required />
            </div>
            <div class="form-group">
              <label for="editLocation"
                ><i class="fas fa-map-marker-alt"></i> Location</label
              >
              <input type="text" id="editLocation" required />
            </div>
            <div class="form-group">
              <label for="editServiceType"
                ><i class="fas fa-cut"></i> Service Type</label
              >
              <select id="editServiceType">
                <option value="shop">In-shop</option>
                <option value="home">Home service</option>
                <option value="both">Both</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeEditModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveProfile()">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="manageServicesModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Manage Services</h3>
          <button class="btn-icon close-modal" onclick="closeServicesModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="servicesListModal"></div>
          <button class="btn btn-secondary btn-block" onclick="addNewService()">
            <i class="fas fa-plus"></i> Add New Service
          </button>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeServicesModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveServices()">
            <i class="fas fa-save"></i> Save Services
          </button>
        </div>
      </div>
    </div>

    <!-- Block Time Modal -->
    <div class="modal" id="blockTimeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-ban"></i> Block Time</h3>
          <button class="btn-icon close-modal" onclick="closeBlockTimeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="blockTimeForm">
            <div class="form-group">
              <label for="blockDate"
                ><i class="fas fa-calendar"></i> Date</label
              >
              <input type="date" id="blockDate" required />
            </div>
            <div class="form-group">
              <label for="blockStartTime"
                ><i class="fas fa-clock"></i> Start Time</label
              >
              <input type="time" id="blockStartTime" value="09:00" required />
            </div>
            <div class="form-group">
              <label for="blockEndTime"
                ><i class="fas fa-clock"></i> End Time</label
              >
              <input type="time" id="blockEndTime" value="18:00" required />
            </div>
            <div class="form-group">
              <label for="blockReason"
                ><i class="fas fa-sticky-note"></i> Reason (Optional)</label
              >
              <input
                type="text"
                id="blockReason"
                placeholder="Lunch break, Personal time, etc."
              />
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="repeatWeekly" />
                <i class="fas fa-redo"></i> Repeat weekly
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeBlockTimeModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveBlockTime()">
            <i class="fas fa-ban"></i> Block Time
          </button>
        </div>
      </div>
    </div>

    <!-- View All Bookings Modal -->
    <div class="modal" id="viewAllBookingsModal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h3><i class="fas fa-calendar-week"></i> All Bookings</h3>
          <div style="display: flex; gap: 10px">
            <select
              id="bookingFilter"
              onchange="filterBookingsView()"
              style="padding: 6px 12px; border-radius: 6px"
            >
              <option value="all">All Bookings</option>
              <option value="upcoming">Upcoming</option>
              <option value="past">Past</option>
              <option value="today">Today</option>
              <option value="confirmed">Confirmed</option>
              <option value="pending">Pending</option>
            </select>
            <button class="btn-icon close-modal" onclick="closeViewAllModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="modal-body">
          <div id="allBookingsList" style="max-height: 400px; overflow-y: auto">
            <!-- Bookings will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="exportBookings()">
            <i class="fas fa-download"></i> Export
          </button>
          <button class="btn btn-primary" onclick="addBooking()">
            <i class="fas fa-plus"></i> Add Booking
          </button>
        </div>
      </div>
    </div>

    <!-- Manage Availability Modal -->
    <div class="modal" id="manageAvailabilityModal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3><i class="fas fa-user-clock"></i> Manage Availability</h3>
          <button
            class="btn-icon close-modal"
            onclick="closeManageAvailabilityModal()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px">
            <div>
              <h4 style="margin-bottom: 16px">
                <i class="fas fa-clock"></i> Business Hours
              </h4>
              <div class="form-group">
                <label for="availabilityStartTime">Start Time</label>
                <input type="time" id="availabilityStartTime" value="09:00" />
              </div>
              <div class="form-group">
                <label for="availabilityEndTime">End Time</label>
                <input type="time" id="availabilityEndTime" value="18:00" />
              </div>
              <button
                class="btn btn-primary"
                onclick="updateBusinessHours()"
                style="margin-top: 10px"
              >
                <i class="fas fa-save"></i> Update Hours
              </button>
            </div>
            <div>
              <h4 style="margin-bottom: 16px">
                <i class="fas fa-calendar-alt"></i> Quick Selection
              </h4>
              <div style="display: flex; flex-direction: column; gap: 8px">
                <button class="btn btn-secondary" onclick="selectAllWeekdays()">
                  <i class="fas fa-calendar-day"></i> All Weekdays
                </button>
                <button class="btn btn-secondary" onclick="selectWeekends()">
                  <i class="fas fa-calendar-weekend"></i> Weekends Only
                </button>
                <button class="btn btn-secondary" onclick="selectNext7Days()">
                  <i class="fas fa-calendar-plus"></i> Next 7 Days
                </button>
                <button class="btn btn-danger" onclick="clearAllAvailability()">
                  <i class="fas fa-trash"></i> Clear All
                </button>
              </div>
              <div
                style="
                  margin-top: 20px;
                  padding: 12px;
                  background: #f3f4f6;
                  border-radius: 8px;
                "
              >
                <p style="font-size: 0.9rem; color: #6b7280">
                  <i class="fas fa-info-circle"></i>
                  Click on calendar days in dashboard to toggle individual
                  availability.
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              margin-top: 24px;
              padding-top: 24px;
              border-top: 1px solid #e5e7eb;
            "
          >
            <h4 style="margin-bottom: 16px">
              <i class="fas fa-list"></i> Current Available Days
            </h4>
            <div
              id="availabilityList"
              style="
                max-height: 200px;
                overflow-y: auto;
                padding: 12px;
                background: #f9fafb;
                border-radius: 8px;
              "
            >
              <!-- Available days will be listed here -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeManageAvailabilityModal()"
          >
            Close
          </button>
          <button class="btn btn-primary" onclick="syncWithOnboarding()">
            <i class="fas fa-sync"></i> Sync with Onboarding
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
      // Global variables
      const today = new Date();
      let currentMonth = today.getMonth();
      let currentYear = today.getFullYear();
      let bookings = [];

      // Initialize date display
      document.getElementById("todayDate").textContent =
        today.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

      document.getElementById("todayDateShort").textContent =
        today.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
        });

      // Load onboarding data
      function loadOnboardingData() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const profile = onboardingData.profile || {};
        const services = onboardingData.services || [];
        const availability = onboardingData.availability || {};

        // Update profile information
        document.getElementById("welcomeName").textContent =
          profile.name || "Barber";
        document.getElementById("barberLocation").textContent =
          profile.location || "Location not set";

        // Update service type
        const serviceTypeMap = {
          shop: "In-shop",
          home: "Home service",
          both: "Both in-shop and home service",
        };
        document.getElementById("businessType").textContent =
          serviceTypeMap[profile.serviceType] || "In-shop";

        // Update business hours
        if (availability.startTime && availability.endTime) {
          const startTime = formatTime(availability.startTime);
          const endTime = formatTime(availability.endTime);
          document.getElementById(
            "businessHours"
          ).textContent = `${startTime} - ${endTime}`;
          document.getElementById(
            "businessHoursDetail"
          ).textContent = `${startTime} - ${endTime}`;
        }

        // Update service count
        document.getElementById("serviceCount").textContent = services.length;

        // Load services
        loadServices(services);

        // Update availability count
        updateAvailabilityCount();

        return { profile, services, availability };
      }

      function formatTime(timeString) {
        if (!timeString) return "9:00 AM";
        const [hours, minutes] = timeString.split(":");
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? "PM" : "AM";
        const formattedHour = hour % 12 || 12;
        return `${formattedHour}:${minutes} ${ampm}`;
      }

      function loadServices(services) {
        const servicesList = document.getElementById("servicesList");
        const serviceTypeSelect = document.getElementById("serviceType");

        if (!services || services.length === 0) {
          servicesList.innerHTML = `
              <div class="empty-state">
                  <i class="fas fa-cut"></i>
                  <h4>No services added</h4>
                  <p>Add your services to get started</p>
                  <button class="btn btn-primary btn-sm" onclick="manageServices()" style="margin-top: 10px;">
                      <i class="fas fa-plus"></i> Add Services
                  </button>
              </div>
          `;
          return;
        }

        // Clear and populate services select
        serviceTypeSelect.innerHTML =
          '<option value="">Select a service</option>';
        services.forEach((service) => {
          const option = document.createElement("option");
          option.value = service.name;
          // CHANGE THIS LINE: Replace $ with 
          option.textContent = `${service.name} - ${service.price} (${service.duration} min)`;
          option.dataset.price = service.price;
          option.dataset.duration = service.duration;
          serviceTypeSelect.appendChild(option);
        });

        // Display services
        servicesList.innerHTML = "";
        services.forEach((service) => {
          const serviceCard = document.createElement("div");
          serviceCard.className = "service-card";
          serviceCard.innerHTML = `
              <h5>${service.name}</h5>
              <div class="service-price">${service.price}</div>
              <div class="service-duration">${service.duration} minutes</div>
          `;
          servicesList.appendChild(serviceCard);
        });
      }

      // Load bookings
      function loadBookings() {
        bookings = JSON.parse(localStorage.getItem("bookings")) || [];

        // If no bookings, create sample data with proper structure
        if (bookings.length === 0) {
          const todayStr = today.toISOString().split("T")[0];
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = tomorrow.toISOString().split("T")[0];

          bookings = [
            {
              id: 1,
              customer: "John Doe",
              service: "Haircut",
              date: todayStr,
              time: "10:00",
              duration: 30,
              price: 5000,
              status: "confirmed",
              phone: "+234 123 456 7890",
              notes: "Regular customer, prefers fade haircut",
            },
            {
              id: 2,
              customer: "Michael Smith",
              service: "Beard Trim",
              date: todayStr,
              time: "14:00",
              duration: 20,
              price: 3000,
              status: "confirmed",
              phone: "+234 987 654 3210",
              notes: "First time customer",
            },
            {
              id: 3,
              customer: "David Johnson",
              service: "Haircut & Beard Trim",
              date: tomorrowStr,
              time: "11:00",
              duration: 45,
              price: 7000,
              status: "pending",
              phone: "+234 456 789 0123",
              notes: "Special request: Hot towel treatment",
            },
            {
              id: 4,
              customer: "Robert Williams",
              service: "Haircut",
              date: tomorrowStr,
              time: "15:30",
              duration: 30,
              price: 5000,
              status: "confirmed",
              phone: "+234 789 012 3456",
              notes: "VIP customer",
            },
          ];
          localStorage.setItem("bookings", JSON.stringify(bookings));
        }

        // Clean up any bookings with missing required fields
        bookings = bookings.filter((booking) => {
          if (!booking || typeof booking !== "object") return false;

          // Ensure required fields exist
          if (!booking.customer && !booking.name) {
            booking.customer = "Unknown Customer";
          }

          if (!booking.service && !booking.serviceType) {
            booking.service = "Haircut";
          }

          if (!booking.status) {
            booking.status = "pending";
          }

          if (!booking.price) {
            booking.price = 5000; // Default price
          }

          if (!booking.duration) {
            booking.duration = 30; // Default duration
          }

          return true;
        });

        // Save cleaned data back to localStorage
        localStorage.setItem("bookings", JSON.stringify(bookings));
      }

      function loadTodayBookings() {
        const container = document.getElementById("todayBookings");
        container.innerHTML = "";

        const todayStr = today.toISOString().split("T")[0];
        const todaysBookings = bookings.filter((b) => b.date === todayStr);

        document.getElementById("todayCount").textContent =
          todaysBookings.length;

        if (todaysBookings.length === 0) {
          container.innerHTML = `
              <div class="empty-state">
                <i class="far fa-calendar-times"></i>
                <h4>No bookings today</h4>
                <p>You're all caught up! Enjoy your day.</p>
                <button class="btn btn-primary" onclick="addBooking()" style="margin-top: 15px;">
                  <i class="fas fa-plus-circle"></i> Add Booking
                </button>
              </div>
            `;
          return;
        }

        todaysBookings.sort((a, b) => a.time.localeCompare(b.time));
        todaysBookings.forEach((booking) => {
          const bookingItem = document.createElement("div");
          bookingItem.className = "booking-item active";
          bookingItem.onclick = () => openModal(booking);
          bookingItem.innerHTML = `
              <div class="booking-info">
                <h4>${booking.customer}</h4>
                <div class="booking-meta">
                  <span><i class="far fa-clock"></i> ${booking.time}</span>
                  <span><i class="fas fa-cut"></i> ${booking.service}</span>
                  <span><i class="far fa-clock"></i> ${
                    booking.duration
                  } min</span>
                </div>
              </div>
              <div class="booking-status status-${booking.status}">
                ${
                  booking.status.charAt(0).toUpperCase() +
                  booking.status.slice(1)
                }
              </div>
            `;
          container.appendChild(bookingItem);
        });

        // Update upcoming count
        const next7Days = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          next7Days.push(date.toISOString().split("T")[0]);
        }
        const upcomingBookings = bookings.filter(
          (b) => next7Days.includes(b.date) && b.date !== todayStr
        );
        document.getElementById("upcomingCount").textContent =
          upcomingBookings.length;

        // Calculate revenue
        const todayRevenue = todaysBookings.reduce(
          (total, booking) => total + booking.price,
          0
        );
        document.getElementById(
          "revenueCount"
        ).textContent = `${todayRevenue}`;
      }

      function loadMiniCalendar() {
        const calendar = document.getElementById("miniCalendar");
        if (!calendar) return;

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        document.getElementById(
          "currentMonth"
        ).textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();

        calendar.innerHTML = "";

        // Empty cells for days before the first
        for (let i = 0; i < startingDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "calendar-day other-month";
          emptyDay.textContent = "";
          calendar.appendChild(emptyDay);
        }

        // Days of the month
        for (let d = 1; d <= daysInMonth; d++) {
          const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(
            2,
            "0"
          )}-${String(d).padStart(2, "0")}`;
          const dayElement = document.createElement("div");
          dayElement.className = "calendar-day";
          dayElement.textContent = d;
          dayElement.dataset.date = dateKey; // Store date for click handling

          // Check if it's today
          if (
            currentYear === today.getFullYear() &&
            currentMonth === today.getMonth() &&
            d === today.getDate()
          ) {
            dayElement.classList.add("today");
          }

          // Check for bookings
          const hasBooking = bookings.some((b) => b.date === dateKey);
          if (hasBooking) {
            dayElement.classList.add("has-booking");
          }

          // Check availability and make clickable
          const onboardingData =
            JSON.parse(localStorage.getItem("onboardingData")) || {};
          const availability = onboardingData.availability || {};
          const availableDays = availability.days || [];

          // Check if this specific date is in availableDays
          const isAvailable = availableDays.includes(dateKey);

          if (isAvailable) {
            dayElement.classList.add("available-day");
            dayElement.style.backgroundColor = "#000000";
            dayElement.style.color = "#ffffff";
            dayElement.style.borderColor = "#000000";
            dayElement.title = "Available (click to remove)";
          } else {
            dayElement.title = "Not available (click to add)";
          }

          // Add click event to toggle availability
          dayElement.addEventListener("click", toggleDayAvailability);

          calendar.appendChild(dayElement);
        }

        // Update month navigation
        document.getElementById("prevMonth").onclick = () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          loadMiniCalendar();
          updateAvailabilityCount();
        };

        document.getElementById("nextMonth").onclick = () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          loadMiniCalendar();
          updateAvailabilityCount();
        };
      }

      function updateAvailabilityCount() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};
        const availableDays = availability.days || [];

        // Count available days in current month
        const currentMonthStart = `${currentYear}-${String(
          currentMonth + 1
        ).padStart(2, "0")}-01`;
        const currentMonthEnd = `${currentYear}-${String(
          currentMonth + 1
        ).padStart(2, "0")}-${new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate()}`;

        const availableDaysCount = availableDays.filter((day) => {
          return day >= currentMonthStart && day <= currentMonthEnd;
        }).length;

        // Also update total count in welcome section
        const totalAvailable = availableDays.length;
        document.getElementById("availableDays").textContent = totalAvailable;

        document.getElementById(
          "availableDaysCount"
        ).textContent = `${availableDaysCount} days available this month`;
      }

      // Modal functions
      function openModal(booking) {
        const modal = document.getElementById("bookingModal");
        const details = document.getElementById("bookingDetails");

        // Ensure booking has all required fields
        const safeBooking = {
          ...booking,
          customer: booking.customer || booking.name || "Unknown Customer",
          service: booking.service || booking.serviceType || "Haircut",
          date: booking.date || new Date().toISOString().split("T")[0],
          time: booking.time || "10:00",
          duration: booking.duration || 30,
          price: booking.price || 5000,
          status: booking.status || "pending",
          phone: booking.phone || "No phone provided",
          notes: booking.notes || "No notes provided.",
        };

        const bookingDate = new Date(safeBooking.date);
        const formattedDate = bookingDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        details.innerHTML = `
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">${safeBooking.customer}</h3>
          <span class="booking-status status-${
            safeBooking.status
          }" style="padding: 6px 12px;">
            ${
              safeBooking.status.charAt(0).toUpperCase() +
              safeBooking.status.slice(1)
            }
          </span>
        </div>
        ${
          safeBooking.phone
            ? `<p style="margin: 8px 0 0 0; color: #6b7280;"><i class="fas fa-phone"></i> ${safeBooking.phone}</p>`
            : ""
        }
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
        <div>
          <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Service</div>
          <div style="font-weight: 600;">${safeBooking.service}</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Duration</div>
          <div style="font-weight: 600;">${safeBooking.duration} minutes</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Date</div>
          <div style="font-weight: 600;">${formattedDate}</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Time</div>
          <div style="font-weight: 600;">${formatTime(safeBooking.time)}</div>
        </div>
      </div>
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Price</div>
        <div style="font-weight: 600; font-size: 1.5rem;">${
          safeBooking.price
        }</div>
      </div>
      <div>
        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">Notes</div>
        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
          ${safeBooking.notes}
        </div>
      </div>
    `;

        modal.style.display = "flex";
      }

      function closeModal() {
        document.getElementById("bookingModal").style.display = "none";
      }

      function addBooking() {
        const modal = document.getElementById("addBookingModal");
        const dateInput = document.getElementById("bookingDate");

        const todayStr = today.toISOString().split("T")[0];
        dateInput.min = todayStr;
        dateInput.value = todayStr;

        populateTimeSlots(todayStr);
        dateInput.addEventListener("change", function () {
          populateTimeSlots(this.value);
        });

        modal.style.display = "flex";
      }

      function populateTimeSlots(dateStr) {
        const timeSelect = document.getElementById("bookingTime");
        timeSelect.innerHTML = '<option value="">Select a time</option>';

        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};
        const availableDays = new Set(availability.days || []);

        if (!availableDays.has(dateStr)) {
          timeSelect.innerHTML =
            '<option value="">Not available on this date</option>';
          timeSelect.disabled = true;
          return;
        }

        timeSelect.disabled = false;
        const startTime = availability.startTime || "09:00";
        const endTime = availability.endTime || "18:00";

        const timeSlots = [];
        const [startHour, startMinute] = startTime.split(":").map(Number);
        const [endHour, endMinute] = endTime.split(":").map(Number);

        let currentHour = startHour;
        let currentMinute = startMinute;

        while (
          currentHour < endHour ||
          (currentHour === endHour && currentMinute < endMinute)
        ) {
          const timeString = `${String(currentHour).padStart(2, "0")}:${String(
            currentMinute
          ).padStart(2, "0")}`;

          const isBooked = bookings.some(
            (b) => b.date === dateStr && b.time === timeString
          );
          if (!isBooked) {
            timeSlots.push(timeString);
          }

          currentMinute += 30;
          if (currentMinute >= 60) {
            currentHour++;
            currentMinute -= 60;
          }
        }

        timeSlots.forEach((time) => {
          const option = document.createElement("option");
          option.value = time;
          option.textContent = formatTime(time);
          timeSelect.appendChild(option);
        });

        if (timeSlots.length === 0) {
          timeSelect.innerHTML = '<option value="">No available slots</option>';
          timeSelect.disabled = true;
        }
      }

      function closeAddModal() {
        document.getElementById("addBookingModal").style.display = "none";
        document.getElementById("addBookingForm").reset();
      }

      function saveNewBooking() {
        const customerName = document.getElementById("customerName").value;
        const serviceType = document.getElementById("serviceType").value;
        const bookingDate = document.getElementById("bookingDate").value;
        const bookingTime = document.getElementById("bookingTime").value;

        if (!customerName || !serviceType || !bookingDate || !bookingTime) {
          showToast("Please fill in all fields", "error");
          return;
        }

        const newId =
          bookings.length > 0 ? Math.max(...bookings.map((b) => b.id)) + 1 : 1;
        const newBooking = {
          id: newId,
          customer: customerName,
          service: serviceType,
          date: bookingDate,
          time: bookingTime,
          duration: 30,
          price: 5000, // Default to 5000 instead of $25
          status: "confirmed",
          phone:
            document.getElementById("customerPhone").value ||
            "+1 (555) 000-0000",
          notes: document.getElementById("bookingNotes").value || "New booking",
        };
        bookings.push(newBooking);
        localStorage.setItem("bookings", JSON.stringify(bookings));

        closeAddModal();
        loadTodayBookings();
        loadMiniCalendar();
        showToast(
          `Booking added for ${customerName} at ${bookingTime}`,
          "success"
        );
      }

      function editProfile() {
        const modal = document.getElementById("editProfileModal");
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const profile = onboardingData.profile || {};

        document.getElementById("editName").value = profile.name || "";
        document.getElementById("editPhone").value = profile.phone || "";
        document.getElementById("editLocation").value = profile.location || "";
        document.getElementById("editServiceType").value =
          profile.serviceType || "shop";

        modal.style.display = "flex";
      }

      function closeEditModal() {
        document.getElementById("editProfileModal").style.display = "none";
      }

      function saveProfile() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};

        onboardingData.profile = {
          name: document.getElementById("editName").value,
          phone: document.getElementById("editPhone").value,
          location: document.getElementById("editLocation").value,
          serviceType: document.getElementById("editServiceType").value,
        };

        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));
        closeEditModal();
        loadOnboardingData();
        showToast("Profile updated successfully", "success");
      }

      function manageServices() {
        const modal = document.getElementById("manageServicesModal");
        const servicesList = document.getElementById("servicesListModal");

        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const services = onboardingData.services || [];

        servicesList.innerHTML = "";

        if (services.length === 0) {
          servicesList.innerHTML = `
              <div style="text-align: center; padding: 20px; color: #6b7280;">
                <i class="fas fa-cut" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>No services added yet</p>
              </div>
            `;
        } else {
          services.forEach((service, index) => {
            const serviceItem = document.createElement("div");
            serviceItem.style.cssText =
              "display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;";
            serviceItem.innerHTML = `
                <input type="text" value="${
                  service.name
                }" style="flex: 2; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Service name">
                <input type="number" value="${
                  service.price
                }" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Price">
                <select style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <option value="15" ${
                    service.duration == 15 ? "selected" : ""
                  }>15 min</option>
                  <option value="30" ${
                    service.duration == 30 ? "selected" : ""
                  }>30 min</option>
                  <option value="45" ${
                    service.duration == 45 ? "selected" : ""
                  }>45 min</option>
                  <option value="60" ${
                    service.duration == 60 ? "selected" : ""
                  }>60 min</option>
                </select>
                <button onclick="removeService(${index})" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 8px; cursor: pointer;">
                  <i class="fas fa-trash"></i>
                </button>
              `;
            servicesList.appendChild(serviceItem);
          });
        }

        modal.style.display = "flex";
      }

      function addNewService() {
        const servicesList = document.getElementById("servicesListModal");
        const serviceItem = document.createElement("div");
        serviceItem.style.cssText =
          "display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;";
        serviceItem.innerHTML = `
            <input type="text" value="" style="flex: 2; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Service name">
            <input type="number" value="" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Price">
            <select style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
              <option value="15">15 min</option>
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
            </select>
            <button onclick="this.parentElement.remove()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 8px; cursor: pointer;">
              <i class="fas fa-trash"></i>
            </button>
          `;
        servicesList.appendChild(serviceItem);
      }

      function removeService(index) {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const services = onboardingData.services || [];

        services.splice(index, 1);
        onboardingData.services = services;

        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));
        manageServices();
        showToast("Service removed", "warning");
      }

      function closeServicesModal() {
        document.getElementById("manageServicesModal").style.display = "none";
      }

      function saveServices() {
        const serviceItems = document.querySelectorAll(
          "#servicesListModal > div"
        );
        const services = [];

        serviceItems.forEach((item) => {
          const inputs = item.querySelectorAll("input, select");
          const name = inputs[0].value;
          const price = inputs[1].value;
          const duration = inputs[2].value;

          if (name && price && duration) {
            services.push({
              name: name,
              price: parseFloat(price),
              duration: parseInt(duration),
            });
          }
        });

        if (services.length === 0) {
          showToast("Please add at least one service", "error");
          return;
        }

        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        onboardingData.services = services;

        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));
        closeServicesModal();
        loadOnboardingData();
        showToast("Services updated successfully", "success");
      }

      function viewAvailability() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};
        const availableDays = availability.days || [];

        if (availableDays.length === 0) {
          showToast(
            "No availability set. Please set your availability first.",
            "warning"
          );
          return;
        }

        const formattedDays = availableDays
          .map((day) => {
            const date = new Date(day);
            return date.toLocaleDateString("en-US", {
              weekday: "short",
              month: "short",
              day: "numeric",
            });
          })
          .join(", ");

        showToast(`Available on: ${formattedDays}`, "info");
      }

      function cancelBooking() {
        const modal = document.getElementById("bookingModal");
        if (confirm("Are you sure you want to cancel this booking?")) {
          closeModal();
          showToast("Booking cancelled", "warning");
        }
      }

      function confirmBooking() {
        closeModal();
        showToast("Booking confirmed", "success");
      }

      function blockTime() {
        showToast("Block time feature coming soon", "info");
      }

      function viewAllBookings() {
        showToast("Viewing all bookings", "info");
      }

      function manageAvailability() {
        showToast("Availability management coming soon", "info");
      }

      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast ${type}`;

        let icon = "fas fa-info-circle";
        if (type === "success") icon = "fas fa-check-circle";
        if (type === "error") icon = "fas fa-exclamation-circle";
        if (type === "warning") icon = "fas fa-exclamation-triangle";

        toast.innerHTML = `<i class="${icon}"></i> ${message}`;

        setTimeout(() => toast.classList.add("show"), 10);
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function toggleDayAvailability(event) {
        const dayElement = event.currentTarget;
        const dateKey = dayElement.dataset.date;

        // Don't allow toggling for past dates
        const dateObj = new Date(dateKey);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (dateObj < today) {
          showToast("Cannot modify availability for past dates", "warning");
          return;
        }

        // Get current availability
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability) {
          onboardingData.availability = {};
        }

        const availability = onboardingData.availability;
        if (!availability.days) {
          availability.days = [];
        }

        const availableDays = availability.days;

        // Check if date is already available
        const isAvailable = availableDays.includes(dateKey);

        if (isAvailable) {
          // Remove from available days
          const index = availableDays.indexOf(dateKey);
          availableDays.splice(index, 1);

          // Update UI
          dayElement.classList.remove("available-day");
          dayElement.style.backgroundColor = "";
          dayElement.style.color = "";
          dayElement.style.borderColor = "";
          dayElement.title = "Not available (click to add)";

          showToast(`Removed ${formatDate(dateKey)} from availability`, "info");
        } else {
          // Add to available days
          availableDays.push(dateKey);

          // Sort dates chronologically
          availableDays.sort();

          // Update UI
          dayElement.classList.add("available-day");
          dayElement.style.backgroundColor = "#000000";
          dayElement.style.color = "#ffffff";
          dayElement.style.borderColor = "#000000";
          dayElement.title = "Available (click to remove)";

          showToast(`Added ${formatDate(dateKey)} to availability`, "success");
        }

        // Save to localStorage
        onboardingData.availability.days = availableDays;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        // Update availability count
        updateAvailabilityCount();

        // Also update welcome section count
        const totalAvailable = availableDays.length;
        document.getElementById("availableDays").textContent = totalAvailable;
      }

      function clearAllAvailability() {
        if (
          !confirm(
            "Clear all availability for this month? This will remove all selected available days."
          )
        ) {
          return;
        }

        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability || !onboardingData.availability.days) {
          showToast("No availability to clear", "info");
          return;
        }

        // Filter out dates from current month
        const currentMonthStart = `${currentYear}-${String(
          currentMonth + 1
        ).padStart(2, "0")}-01`;
        const currentMonthEnd = `${currentYear}-${String(
          currentMonth + 1
        ).padStart(2, "0")}-${new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate()}`;

        const availableDays = onboardingData.availability.days;
        const remainingDays = availableDays.filter((date) => {
          return date < currentMonthStart || date > currentMonthEnd;
        });

        onboardingData.availability.days = remainingDays;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        // Reload calendar
        loadMiniCalendar();
        updateAvailabilityCount();

        showToast("Cleared availability for this month", "warning");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
        });
      }

      // Sidebar functionality
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("mobile-overlay");
        const hamburgerBtn = document.getElementById("hamburger-btn");
        const isMobile = window.innerWidth <= 1024;

        if (isMobile) {
          sidebar.classList.toggle("mobile-open");
          if (sidebar.classList.contains("mobile-open")) {
            overlay.style.display = "block";
            setTimeout(() => (overlay.style.opacity = "1"), 10);
            // Hamburger button will be hidden by CSS when sidebar is open
          } else {
            overlay.style.opacity = "0";
            setTimeout(() => (overlay.style.display = "none"), 300);
            // Hamburger button will be visible again when sidebar is closed
          }
        } else {
          sidebar.classList.toggle("collapsed");
        }
      }

      function syncOnboardingAvailability() {
        // Get onboarding data
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};

        // If no availability is set, create default from onboarding
        if (!availability.days || availability.days.length === 0) {
          // Try to get weekly pattern
          const weeklyPattern = availability.weeklyPattern || [];

          if (weeklyPattern.length > 0) {
            // Generate availability for next 30 days based on weekly pattern
            const today = new Date();
            const availableDays = [];
            const dayNames = [
              "sunday",
              "monday",
              "tuesday",
              "wednesday",
              "thursday",
              "friday",
              "saturday",
            ];

            for (let i = 0; i < 30; i++) {
              const date = new Date(today);
              date.setDate(date.getDate() + i);
              const dayOfWeek = dayNames[date.getDay()];

              if (weeklyPattern.includes(dayOfWeek)) {
                const dateString = date.toISOString().split("T")[0];
                availableDays.push(dateString);
              }
            }

            availability.days = availableDays;
            onboardingData.availability = availability;
            localStorage.setItem(
              "onboardingData",
              JSON.stringify(onboardingData)
            );
          }
        }
      }

      function migrateOnboardingDates() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability || !onboardingData.availability.days)
          return;

        const convertedDates = onboardingData.availability.days.map(
          (dateStr) => {
            // Convert from "2024-1-8" to "2024-01-08"
            if (dateStr && dateStr.includes("-")) {
              const parts = dateStr.split("-");
              if (parts.length === 3) {
                const [year, month, day] = parts;
                // Only convert if not already in correct format
                if (month.length < 2 || day.length < 2) {
                  return `${year}-${String(month).padStart(2, "0")}-${String(
                    day
                  ).padStart(2, "0")}`;
                }
              }
            }
            return dateStr;
          }
        );

        onboardingData.availability.days = convertedDates;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));
        console.log("Migrated dates:", convertedDates);
      }

      // ===== BLOCK TIME FUNCTIONS =====
      function blockTimeModal() {
        const modal = document.getElementById("blockTimeModal");
        const todayStr = new Date().toISOString().split("T")[0];

        document.getElementById("blockDate").value = todayStr;
        document.getElementById("blockDate").min = todayStr;

        modal.style.display = "flex";
      }

      function closeBlockTimeModal() {
        document.getElementById("blockTimeModal").style.display = "none";
        document.getElementById("blockTimeForm").reset();
      }

      function saveBlockTime() {
        const date = document.getElementById("blockDate").value;
        const startTime = document.getElementById("blockStartTime").value;
        const endTime = document.getElementById("blockEndTime").value;
        const reason =
          document.getElementById("blockReason").value || "Blocked time";
        const repeatWeekly = document.getElementById("repeatWeekly").checked;

        if (!date || !startTime || !endTime) {
          showToast("Please fill in all required fields", "error");
          return;
        }

        // Get existing blocked times
        let blockedTimes =
          JSON.parse(localStorage.getItem("blockedTimes")) || [];

        const newBlock = {
          id: Date.now(),
          date: date,
          startTime: startTime,
          endTime: endTime,
          reason: reason,
          repeatWeekly: repeatWeekly,
          createdAt: new Date().toISOString(),
        };

        blockedTimes.push(newBlock);
        localStorage.setItem("blockedTimes", JSON.stringify(blockedTimes));

        // If repeating weekly, add future blocks
        if (repeatWeekly) {
          for (let i = 1; i <= 12; i++) {
            // 12 weeks ahead
            const nextDate = new Date(date);
            nextDate.setDate(nextDate.getDate() + 7 * i);
            const nextDateStr = nextDate.toISOString().split("T")[0];

            blockedTimes.push({
              ...newBlock,
              id: Date.now() + i,
              date: nextDateStr,
              originalBlockId: newBlock.id,
            });
          }
          localStorage.setItem("blockedTimes", JSON.stringify(blockedTimes));
        }

        closeBlockTimeModal();
        showToast(
          `Time blocked from ${formatTime(startTime)} to ${formatTime(
            endTime
          )} on ${formatDate(date)}`,
          "success"
        );

        // Refresh calendar to show blocked times
        loadMiniCalendar();
      }

      // ===== VIEW ALL BOOKINGS FUNCTIONS =====
      function viewAllBookings() {
        const modal = document.getElementById("viewAllBookingsModal");
        loadAllBookingsView();
        modal.style.display = "flex";
      }

      function closeViewAllModal() {
        document.getElementById("viewAllBookingsModal").style.display = "none";
      }

      function loadAllBookingsView(filter = "all") {
        const container = document.getElementById("allBookingsList");
        container.innerHTML = "";

        // Ensure bookings array exists
        if (!bookings || !Array.isArray(bookings)) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 16px;"></i>
                <h4>No booking data found</h4>
                <p>Please add some bookings to get started</p>
            </div>
        `;
          return;
        }

        let filteredBookings = [...bookings];

        // Apply filters
        const today = new Date().toISOString().split("T")[0];

        switch (filter) {
          case "upcoming":
            filteredBookings = bookings.filter(
              (b) => b.date && b.date >= today
            );
            break;
          case "past":
            filteredBookings = bookings.filter((b) => b.date && b.date < today);
            break;
          case "today":
            filteredBookings = bookings.filter(
              (b) => b.date && b.date === today
            );
            break;
          case "confirmed":
            filteredBookings = bookings.filter((b) => b.status === "confirmed");
            break;
          case "pending":
            filteredBookings = bookings.filter((b) => b.status === "pending");
            break;
          // 'all' shows everything
        }

        // Filter out any invalid bookings (missing required fields)
        filteredBookings = filteredBookings.filter((booking) => {
          return (
            booking &&
            (booking.customer || booking.name) && // Check both possible field names
            booking.date &&
            booking.time
          );
        });

        // Sort by date then time
        filteredBookings.sort((a, b) => {
          if (a.date === b.date) {
            return (a.time || "").localeCompare(b.time || "");
          }
          return (a.date || "").localeCompare(b.date || "");
        });

        if (filteredBookings.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                <i class="far fa-calendar-times" style="font-size: 3rem; margin-bottom: 16px;"></i>
                <h4>No bookings found</h4>
                <p>Try a different filter or add some bookings</p>
            </div>
        `;
          return;
        }

        filteredBookings.forEach((booking) => {
          // Get customer name from either 'customer' or 'name' field
          const customerName =
            booking.customer || booking.name || "Unknown Customer";
          const serviceName =
            booking.service || booking.serviceType || "Haircut";
          const bookingStatus = booking.status || "pending";
          const bookingPrice = booking.price || 0;
          const bookingTime = booking.time || "12:00";
          const bookingDate = booking.date || today;
          const bookingNotes = booking.notes || "";

          const bookingDateObj = new Date(bookingDate);
          const formattedDate = bookingDateObj.toLocaleDateString("en-US", {
            weekday: "short",
            month: "short",
            day: "numeric",
            year: "numeric",
          });

          const bookingItem = document.createElement("div");
          bookingItem.className = "booking-item";
          bookingItem.style.marginBottom = "12px";
          bookingItem.style.padding = "16px";
          bookingItem.style.border = "1px solid #e5e7eb";
          bookingItem.style.borderRadius = "8px";
          bookingItem.style.cursor = "pointer";
          bookingItem.style.transition = "all 0.2s ease";

          bookingItem.onmouseenter = function () {
            this.style.borderColor = "#3b82f6";
            this.style.boxShadow = "0 2px 8px rgba(59, 130, 246, 0.1)";
          };

          bookingItem.onmouseleave = function () {
            this.style.borderColor = "#e5e7eb";
            this.style.boxShadow = "none";
          };

          bookingItem.onclick = () => {
            closeViewAllModal();
            openModal(booking);
          };

          // Create status badge with proper colors
          let statusColor = "#6b7280"; // default gray
          let bgColor = "#f3f4f6";

          switch (bookingStatus) {
            case "confirmed":
              statusColor = "#10b981";
              bgColor = "#d1fae5";
              break;
            case "pending":
              statusColor = "#f59e0b";
              bgColor = "#fef3c7";
              break;
            case "cancelled":
              statusColor = "#ef4444";
              bgColor = "#fee2e2";
              break;
            case "completed":
              statusColor = "#3b82f6";
              bgColor = "#dbeafe";
              break;
          }

          bookingItem.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0; font-size: 1.1rem; color: #111827;">
                        ${customerName}
                        ${
                          booking.phone
                            ? `<span style="font-size: 0.9rem; color: #6b7280; margin-left: 8px;">${booking.phone}</span>`
                            : ""
                        }
                    </h4>
                    <div style="display: flex; gap: 16px; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <i class="far fa-calendar"></i> ${formattedDate}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <i class="far fa-clock"></i> ${formatTime(
                              bookingTime
                            )}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-cut"></i> ${serviceName}
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            <i class="far fa-clock"></i> ${
                              booking.duration || 30
                            } min
                        </span>
                    </div>
                    ${
                      bookingNotes
                        ? `
                    <div style="font-size: 0.9rem; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px; margin-top: 8px;">
                        <i class="fas fa-sticky-note"></i> ${bookingNotes}
                    </div>
                    `
                        : ""
                    }
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end; margin-left: 16px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; 
                           color: ${statusColor}; background: ${bgColor};">
                        ${
                          bookingStatus.charAt(0).toUpperCase() +
                          bookingStatus.slice(1)
                        }
                    </span>
                    <span style="font-weight: 700; color: #111827; font-size: 1.2rem;">
                        ${bookingPrice}
                    </span>
                    <div style="font-size: 0.8rem; color: #9ca3af;">
                        ID: ${booking.id || "N/A"}
                    </div>
                </div>
            </div>
        `;

          container.appendChild(bookingItem);
        });
      }

      function filterBookingsView() {
        const filter = document.getElementById("bookingFilter").value;
        loadAllBookingsView(filter);
      }

      function exportBookings() {
        // Simple export to JSON
        const dataStr = JSON.stringify(bookings, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportFileDefaultName = `bookings_${
          new Date().toISOString().split("T")[0]
        }.json`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();

        showToast("Bookings exported successfully", "success");
      }

      // ===== MANAGE AVAILABILITY FUNCTIONS =====
      function manageAvailabilityModal() {
        const modal = document.getElementById("manageAvailabilityModal");
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};

        // Load current business hours
        if (availability.startTime) {
          document.getElementById("availabilityStartTime").value =
            availability.startTime;
        }
        if (availability.endTime) {
          document.getElementById("availabilityEndTime").value =
            availability.endTime;
        }

        // Load availability list
        loadAvailabilityList();

        modal.style.display = "flex";
      }

      function closeManageAvailabilityModal() {
        document.getElementById("manageAvailabilityModal").style.display =
          "none";
      }

      function updateBusinessHours() {
        const startTime = document.getElementById(
          "availabilityStartTime"
        ).value;
        const endTime = document.getElementById("availabilityEndTime").value;

        if (!startTime || !endTime) {
          showToast("Please set both start and end times", "error");
          return;
        }

        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability) {
          onboardingData.availability = {};
        }

        onboardingData.availability.startTime = startTime;
        onboardingData.availability.endTime = endTime;

        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        // Update display
        document.getElementById("businessHours").textContent = `${formatTime(
          startTime
        )} - ${formatTime(endTime)}`;
        document.getElementById(
          "businessHoursDetail"
        ).textContent = `${formatTime(startTime)} - ${formatTime(endTime)}`;

        showToast("Business hours updated successfully", "success");
      }

      function loadAvailabilityList() {
        const container = document.getElementById("availabilityList");
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};
        const availableDays = availability.days || [];

        container.innerHTML = "";

        if (availableDays.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <i class="far fa-calendar-times"></i>
                <p>No available days set</p>
            </div>
        `;
          return;
        }

        // Group by month
        const groupedByMonth = {};
        availableDays.forEach((dateStr) => {
          const date = new Date(dateStr);
          const monthYear = date.toLocaleDateString("en-US", {
            month: "long",
            year: "numeric",
          });

          if (!groupedByMonth[monthYear]) {
            groupedByMonth[monthYear] = [];
          }
          groupedByMonth[monthYear].push(dateStr);
        });

        // Sort months chronologically
        const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => {
          return new Date(a) - new Date(b);
        });

        sortedMonths.forEach((monthYear) => {
          const monthSection = document.createElement("div");
          monthSection.style.marginBottom = "16px";

          const monthHeader = document.createElement("h5");
          monthHeader.style.margin = "0 0 8px 0";
          monthHeader.style.fontSize = "0.9rem";
          monthHeader.style.color = "#4b5563";
          monthHeader.textContent = monthYear;

          const daysList = document.createElement("div");
          daysList.style.display = "flex";
          daysList.style.flexWrap = "wrap";
          daysList.style.gap = "6px";

          groupedByMonth[monthYear].forEach((dateStr) => {
            const date = new Date(dateStr);
            const dayElement = document.createElement("span");
            dayElement.style.padding = "4px 8px";
            dayElement.style.background = "#000";
            dayElement.style.color = "#fff";
            dayElement.style.borderRadius = "4px";
            dayElement.style.fontSize = "0.8rem";
            dayElement.style.cursor = "pointer";
            dayElement.title = "Click to remove";
            dayElement.textContent = date.getDate();

            dayElement.onclick = () => {
              removeAvailableDay(dateStr);
            };

            daysList.appendChild(dayElement);
          });

          monthSection.appendChild(monthHeader);
          monthSection.appendChild(daysList);
          container.appendChild(monthSection);
        });
      }

      function removeAvailableDay(dateStr) {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        const availability = onboardingData.availability || {};
        const availableDays = availability.days || [];

        const index = availableDays.indexOf(dateStr);
        if (index > -1) {
          availableDays.splice(index, 1);
          onboardingData.availability.days = availableDays;
          localStorage.setItem(
            "onboardingData",
            JSON.stringify(onboardingData)
          );

          showToast(`Removed ${formatDate(dateStr)} from availability`, "info");
          loadAvailabilityList();
          loadMiniCalendar();
          updateAvailabilityCount();
        }
      }

      // ===== QUICK SELECTION FUNCTIONS =====
      function selectAllWeekdays() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability) {
          onboardingData.availability = {};
        }

        const availableDays = onboardingData.availability.days || [];
        const today = new Date();

        // Add next 30 weekdays (Monday-Friday)
        for (let i = 0; i < 30; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          const dayOfWeek = date.getDay();

          // 1-5 = Monday-Friday (0 = Sunday, 6 = Saturday)
          if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            const dateStr = date.toISOString().split("T")[0];
            if (!availableDays.includes(dateStr)) {
              availableDays.push(dateStr);
            }
          }
        }

        // Sort and save
        availableDays.sort();
        onboardingData.availability.days = availableDays;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        showToast("Added all weekdays for next 30 days", "success");
        loadAvailabilityList();
        loadMiniCalendar();
        updateAvailabilityCount();
      }

      function selectWeekends() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability) {
          onboardingData.availability = {};
        }

        const availableDays = onboardingData.availability.days || [];
        const today = new Date();

        // Add next 8 weekends (Saturday-Sunday)
        for (let i = 0; i < 56; i++) {
          // 8 weeks
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          const dayOfWeek = date.getDay();

          // 0 = Sunday, 6 = Saturday
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            const dateStr = date.toISOString().split("T")[0];
            if (!availableDays.includes(dateStr)) {
              availableDays.push(dateStr);
            }
          }
        }

        // Sort and save
        availableDays.sort();
        onboardingData.availability.days = availableDays;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        showToast("Added weekends for next 8 weeks", "success");
        loadAvailabilityList();
        loadMiniCalendar();
        updateAvailabilityCount();
      }

      function selectNext7Days() {
        const onboardingData =
          JSON.parse(localStorage.getItem("onboardingData")) || {};
        if (!onboardingData.availability) {
          onboardingData.availability = {};
        }

        const availableDays = onboardingData.availability.days || [];
        const today = new Date();

        // Add next 7 days
        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          const dateStr = date.toISOString().split("T")[0];

          if (!availableDays.includes(dateStr)) {
            availableDays.push(dateStr);
          }
        }

        // Sort and save
        availableDays.sort();
        onboardingData.availability.days = availableDays;
        localStorage.setItem("onboardingData", JSON.stringify(onboardingData));

        showToast("Added next 7 days to availability", "success");
        loadAvailabilityList();
        loadMiniCalendar();
        updateAvailabilityCount();
      }

      function syncWithOnboarding() {
        showToast("Availability synced with onboarding settings", "info");
        // Reload data from onboarding
        loadOnboardingData();
        loadMiniCalendar();
        updateAvailabilityCount();
      }

      function fixBookingData() {
        const allBookings = JSON.parse(localStorage.getItem("bookings")) || [];
        const fixedBookings = allBookings.map((booking, index) => {
          // Ensure booking is an object
          if (!booking || typeof booking !== "object") {
            return {
              id: Date.now() + index,
              customer: "Unknown Customer",
              service: "Haircut",
              date: new Date().toISOString().split("T")[0],
              time: "10:00",
              duration: 30,
              price: 5000,
              status: "pending",
              phone: "",
              notes: "Auto-generated from fix",
            };
          }

          // Ensure all required fields exist
          return {
            id: booking.id || Date.now() + index,
            customer: booking.customer || booking.name || "Unknown Customer",
            service: booking.service || booking.serviceType || "Haircut",
            date: booking.date || new Date().toISOString().split("T")[0],
            time: booking.time || "10:00",
            duration: booking.duration || 30,
            price: booking.price || 5000,
            status: booking.status || "pending",
            phone: booking.phone || "",
            notes: booking.notes || "",
          };
        });

        localStorage.setItem("bookings", JSON.stringify(fixedBookings));
        bookings = fixedBookings;

        console.log("Fixed booking data:", fixedBookings);
        showToast("Booking data structure fixed", "info");
      }

      // Initialize everything
      function initDashboard() {
        // Fix booking data first
        fixBookingData();

        // Sync onboarding availability first
        syncOnboardingAvailability();
        // Migrate old date formats
        migrateOnboardingDates();

        // Load data
        loadBookings();
        loadOnboardingData();
        loadTodayBookings();
        loadMiniCalendar();

        // Setup sidebar
        const sidebar = document.getElementById("sidebar");
        const hamburgerBtn = document.getElementById("hamburger-btn");
        const overlay = document.getElementById("mobile-overlay");
        const toggleIcons = document.querySelectorAll(".sidebar-toggle-icon");

        // Add event listeners
        hamburgerBtn.addEventListener("click", toggleSidebar);
        toggleIcons.forEach((icon) =>
          icon.addEventListener("click", toggleSidebar)
        );

        overlay.addEventListener("click", () => {
          sidebar.classList.remove("mobile-open");
          overlay.style.opacity = "0";
          setTimeout(() => (overlay.style.display = "none"), 300);
        });

        window.addEventListener("resize", () => {
          if (window.innerWidth > 1024) {
            sidebar.classList.remove("mobile-open");
            overlay.style.display = "none";
            overlay.style.opacity = "0";
          }
        });

        // Modal close on outside click
        // Modal close on outside click
        window.onclick = function (event) {
          const modals = [
            "bookingModal",
            "addBookingModal",
            "editProfileModal",
            "manageServicesModal",
            "blockTimeModal",
            "viewAllBookingsModal",
            "manageAvailabilityModal",
          ];
          modals.forEach((modalId) => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
              modal.style.display = "none";
            }
          });
        };

        // Update trends
        document.getElementById("todayTrend").textContent =
          "12% from yesterday";
        document.getElementById("upcomingTrend").innerHTML =
          '<i class="fas fa-minus"></i> Same as last week';
        document.getElementById("revenueTrend").textContent =
          "18% from last week";
      }

      // Start everything when page loads
      document.addEventListener("DOMContentLoaded", initDashboard);

      // Add this function to dashboard.html to update message badge
      function updateMessageBadge() {
        // Get unread count from localStorage
        const unreadCount =
          parseInt(localStorage.getItem("trimly_unread_messages")) || 0;
        const messageBadge = document.querySelector(
          'a[href*="message"] .menu-badge'
        );

        if (messageBadge) {
          messageBadge.textContent = unreadCount > 0 ? unreadCount : "";
          messageBadge.style.display = unreadCount > 0 ? "flex" : "none";
        }

        // Also update header notification badge
        const notificationBadge = document.querySelector(".notification-badge");
        if (notificationBadge && unreadCount > 0) {
          notificationBadge.textContent = unreadCount;
        }
      }

      // Listen for message updates from messages page
      if (typeof BroadcastChannel !== "undefined") {
        const bc = new BroadcastChannel("trimly_messages");
        bc.addEventListener("message", (event) => {
          if (event.data.type === "unread_update") {
            updateMessageBadge();
          }
        });
      }

      // Update badge on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateMessageBadge();

        // Check for updates every 30 seconds
        setInterval(updateMessageBadge, 30000);
      });

      // Start everything when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // First, check onboarding status
        checkOnboardingStatus();

        // Then initialize dashboard
        initDashboard();
      });

      function checkOnboardingStatus() {
        const onboardingComplete = localStorage.getItem("onboardingComplete");
        const hasOnboardingData = localStorage.getItem("onboardingData");

        console.log("Onboarding check:", {
          complete: onboardingComplete,
          hasData: !!hasOnboardingData,
        });

        // Redirect to onboarding if not complete AND no data
        if (onboardingComplete !== "true") {
          if (!hasOnboardingData) {
            window.location.href = "onboarding_barber.html";
            return false;
          } else {
            // If data exists but flag isn't set, set it now
            localStorage.setItem("onboardingComplete", "true");
          }
        }
        return true;
      }
    </script>
  </body>
</html>
